---
title: "MS Prelim Data K23"
author: "Erica Baller"
date: "2/25/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(visreg)
library(lme4)
library(lmerTest)
library(ggplot2)
library(reshape2)
library(pwr)
library(mgcv)
library(stringr)
#functions
source("~/BBL/msanxiety/scripts/ms_functions.R")
```

## MS anxiety analyses

## R Markdown

The first chunk here is reading in appropriate data frames and preprocessing. Two big data frames are read in. The first is the demographic, drug, lab info for the MS patients (from the DAC pull). The second is the data frame of fascicle proportion affected for people with good mimosa (# volume affected/total volume of fascicle). The most important preprocessing occurs in a series of mutate commands. These essentially add new columns to the data frame that can later be used. The thrust of these mutate commands is to define who has depression and who does not.

Of note, in prior iterations of this analysis, we did not consider psychiatric medications in determining group inclusion/exclusion. Turns out it makes a difference, as a lot of people on psychotropic medications were counted as "controls/healthy" in previous analyses. For these preliminary analysis, our inclusion/exclusion are more stringent. Of note, the graph below is irrespective of whether they had good/bad MIMoSA. As such, the MIMoSA subset is smaller. It does however highlight the

<img width="70%" src="/Users/eballer/BBL/msdepression/data/drugs_data/MS_Patient_Depression_Categorizations.png"/>


Inclusion criteria below:

Inclusion MS Criteria (dataframe read in here has already been filtered down using the exclusions below previously)
  1) Scanned under MS protocol (42K)
  2) MS Diagnosis (17K)
  3) Seen by MS doctor (16K)
  
Inclusion criteria for Anxious Group
  1) Have an ICD10 F3* code (in our sample, people have F41.1; 41.3; 41.8; 41.9)
        (may use this later)- https://www.nami.org/About-Mental-Illness/Treatments/Mental-Health-Medications
        
Inclusion criteria for Healthy Group
  1) No F* diagnoses
  2) At least 1 PHQ2 or PHQ9 with a documented 0
  3) Free of psychiatric medications per NAMI website

Exclusions
  If you received the MS protocol or had a diagnosis of MS but never actually saw an MS provider, we cannot be sure that the diagnosis of MS is truly valid, as it is hard to diagnose anyway.
  If you did not have a diagnosis of depression and never completed a PHQ2 or 9, and had no history of medications, we could not safely confirm nor deny the presence of depression. These subjects were excluded from future analyses. We could consider adding these to the healthy group maybe, but not too inclined to do that right now. 

Imaging exclusion
  We are currently only using people who had good MIMOSA (75 or 100). That severely limits our numbers, but that is okay! When we re-QC, we will probably get a lot more into this group.

Final N demographics 
  Anxious: 
  Super clean healthy: 604 (148 unique)
  
(unique, with good MIMoSA):




```{r read_in_df}
homedir <- "/Users/eballer/BBL/msanxiety/"

#open Rds
data_2023_pull <- readRDS(paste0(homedir, "/data/data_2023_pull_with_curated_icd10_codes.rds"))
```

```{r read_in_mimosa_qc}
#This section checks how many unique individuals had QA data, and then how many met MIMoSA QC. Some additional people lost at registration. 

#1 Total unique individuals who also have MS - 890
#2 Total unique who had good MIMoSA - 786
#3 Total unique with bad MIMoSA - 890-786 = 104
#4 Total lost in streamline filtering - 3
#5 Final N going into inclusion/exclusion - 783

#read in mimosa data
mimosa_qc <- read.csv("/Users/eballer/BBL/msdepression/data/melissa_martin_files/csv/mimosa_dataframe", sep = ",", header = FALSE) #n=2840

#preprocess data frame to extract dates, empis, and score
empis_with_qc <- mimosa_qc %>% 
  mutate(EMPI = as.factor(gsub(x = V5, pattern = ".*sub-(.*)/ses-.*/.*", replacement="\\1", perl = TRUE))) %>%
  mutate(EXAM_DATE = gsub(x=V5, pattern = ".*/ses-(.{8})/.*", replacement = "\\1\\2\\3")) %>% 
  mutate(score = V3) 

#merge with whole data frame to make sure we exclude people w/out MS
mimosa_qc_df <- merge(data_2023_pull, empis_with_qc, by = c("EMPI", "EXAM_DATE")) #n = 3592

#get list of unique patients, n = 890
mimosa_qc_unique <- mimosa_qc_df %>%
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  slice(1) %>%
  ungroup #n=890
  
#get list of unique patients with good QC, n = 867
mimosa_unique_score_gre_75 <- mimosa_qc_unique %>%
  filter(score >= 75) %>%
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  mutate(EXAM_DATA = as.character(EXAM_DATE)) %>%
  mutate(EMPI = as.character(EMPI)) %>%
  dplyr::select(EMPI, EXAM_DATE, score) %>%
  slice(1) %>%
  ungroup #n=786
```

```{r merge_df_with_mimosa}

#n=867
df_people_with_good_mimosa <- data_2023_pull %>% 
  group_by(EMPI, EXAM_DATE) %>%
  slice(1) %>%
  left_join(mimosa_unique_score_gre_75, by = c("EMPI", "EXAM_DATE")) %>%
  filter(!is.na(score))
```

### Read in fascicle info, use this to determine proportion and volume of injury within each fascicle, and save it in the df_demo_and_fascicles_df
```{r read_in_fascicle_info}

### by the end of this chunk, the df should include 77 columns each for proportion of injury and volume of injury in each fascicle

##########################################################
#             Read in Fascicle info             #
##########################################################

fascicle_proportions <- read.csv(paste0("/Users/eballer/BBL/msdepression//results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336
fascicle_proportions <- fascicle_proportions %>%
  mutate(EMPI = as.character(EMPI)) %>%
  mutate(EXAM_DATE = as.character(EXAM_DATE))

```

## Merge data with good mimosa
```{r merge_with_good_mimosa}
##########################################################
#             Merge with data_empi              #
##########################################################

 #n = 823
df_demo_and_fascicles <- df_people_with_good_mimosa %>% 
  left_join(fascicle_proportions, by = c("EMPI", "EXAM_DATE")) %>%
  filter(!is.na(Has.MS.Provider)) 


```


```{r add_suffix_to_each_measure}

#########################################
## Get vectors with names of fascicles ##
#########################################

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
fascicle_names_no_cranial_nerves <- fascicle_names[grep("CN", fascicle_names, invert = TRUE)] #n=77, drop cranial nerves

fascicle_names_w_prop_suffix <- gsub(pattern = "(.*)", replacement = "\\1_prop", perl=TRUE, x = fascicle_names_no_cranial_nerves)
fascicle_names_w_vol_suffix <- gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE, x = fascicle_names_no_cranial_nerves)


#write.table(fascicle_names,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names.csv", row.names = F, quote = F, col.names = F)


#read in volumes of fascicles and make columns reflecting volume of disease injured per fascicle

##########################################################
#  Add columns for volume and change proportion names    #
##########################################################

#read in fiber volume values
fiber_volume_values <- read.csv("/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fiber_volume_values.csv", sep=",", header = T)

#remove cranial nerves
fiber_volume_values_no_cranial_nerves <- fiber_volume_values %>% filter(fascicle %in% fascicle_names_no_cranial_nerves) %>%
  slice(order(factor(fascicle, levels = fascicle_names_no_cranial_nerves)))


#extract data frame that only includes the fascicle proportion lost
df_fascicles_prop <- df_demo_and_fascicles[ , (names(df_demo_and_fascicles) %in% fascicle_names_no_cranial_nerves)] 
df_everything_else <- df_demo_and_fascicles[ , !(names(df_demo_and_fascicles) %in% fascicle_names_no_cranial_nerves)]

#multiply each row by the vector of total volumes to extract volume of disease within fascicle
df_fascicles_volumes <- sweep(x = df_fascicles_prop, MARGIN = 2,                        # Sweep with Complex STATS
                  STATS = fiber_volume_values_no_cranial_nerves$volume_full, FUN = "*") %>%
  mutate_if(is.numeric, round) #round all values

# change name of df_fascicle_volumes to have the suffix, and add a suffix for the proportion measures
names(df_fascicles_prop) <- fascicle_names_w_prop_suffix
names(df_fascicles_volumes) <- fascicle_names_w_vol_suffix


#combine back with data_fram
#df_demo_and_fascicle_volumes_full <- cbind(df_everything_else, df_fascicle_volumes)
df_demo_and_fascicles <- cbind(df_everything_else, df_fascicles_prop, df_fascicles_volumes)
```




# Yeo network analysis attempts
###Read in fascicle info
```{r read_in_yeo_fascicle_info}
##########################################################
#             Read in Fascicle info             #
##########################################################
########
#fascicle volumes in yeo networks
########

#read in file with proportions
#fascicle_volumes_yeo_7 <- read.csv(paste0(homedir, "results/yeo_7_network_overlap_proportions.txt"), header = T, sep = ",", na.strings="0")

#make titles nice
#names(fascicle_volumes_yeo_7) <-gsub("prop_in_mask_", "prop_", names(fascicle_volumes_yeo_7))

#make Nas into 0
#fascicle_volumes_yeo_7[is.na(fascicle_volumes_yeo_7)]=0

#read in file with binarized yes/no 
fascicle_volumes_yeo_7_binarized <- read.csv("/Users/eballer/BBL/msdepression/results/yeo_7_network_overlap_proportions_binarized.txt", header = T, sep = ",")

#drop cranial nerves
fascicle_volumes_yeo_7_binarized_no_cranial_nerves <- fascicle_volumes_yeo_7_binarized %>% filter(!grepl('CN', fascicle))

#check that order of df is same as yeo networks
new_df <- gsub(pattern = "_vol", replacement = "", x = names(df_demo_and_fascicles[grep(pattern = "_vol", x = names(df_demo_and_fascicles))]))

combined_df <- data.frame(cbind(new_df, fascicle_volumes_yeo_7_binarized_no_cranial_nerves$fascicle))
names(combined_df) <- c("df", "yeo")

#they match
combined_df$match <- combined_df$df == combined_df$yeo
```

### Calc healthy volume of yeo networks
```{r calc_healthy_volume_of_yeo_networks}
#multiply with the binary yeo maps to get absolute volumes of healthy
fascicle_volumes_yeo_7_full_volumes <- fascicle_volumes_yeo_7_binarized_no_cranial_nerves %>% 
  tibble::remove_rownames() %>%
  tibble::column_to_rownames(var = 'fascicle') %>%
  mutate(across(everything()) * fiber_volume_values_no_cranial_nerves$volume_full) %>%
  rename_with(~ str_c(.x, "_vol"), everything()) 

#sum the volumes of each network to get total. 
sums_of_volume_of_healthy_fascicles_by_network <- fascicle_volumes_yeo_7_full_volumes %>%
  summarise(across(everything(), ~ sum(., na.rm = TRUE)))

```

###Calculate injury to networks for each subject
```{r calculate_injury_to_network}

#grab names of networks, get rid of first element which is "fasiscle"
yeo_network_names <- names(fascicle_volumes_yeo_7_binarized_no_cranial_nerves)[-1] 

df_w_yeo_volume_info <- df_demo_and_fascicles %>%
  # mutate(total_fascicle_vol_lost = rowMeans(across(all_of(fascicle_names_w_vol_suffix)))) %>%
  dplyr::select(EMPI, ends_with("_vol")) %>%
  ungroup()

#add columns to data frame for each network
df_w_yeo_volume_info[,yeo_network_names] = 0

#this has been checked with eyeballs and works. You CAN trust the df_w_yeo_volume_info
for (network in yeo_network_names) {

  for (subj in 1:dim(df_w_yeo_volume_info)[1]) {
      # multiply the binary vector of the network with the fascicle volumes of injury, sum, and store in data frame
      text_to_eval <- paste0("df_w_yeo_volume_info$", network,"[", subj,"]=sum(fascicle_volumes_yeo_7_binarized_no_cranial_nerves$", network,
      "*df_w_yeo_volume_info[",subj,",3:(dim(df_w_yeo_volume_info)[2] - 7)])")
     # print(text_to_eval)
      eval(parse(text=text_to_eval))
  }
}

### going to add 7 more columns to the data frame that contain the volume of injury/total healthy volume
df_w_yeo_volume_info_with_prop_of_network <- tibble(df_w_yeo_volume_info) %>% 
  mutate(across(all_of(yeo_network_names), 
    .names = "{.col}_prop_net"
    
  ))

#go through each subject, and divide their total volume of injury within each network by the overall volume of the network
for (subj in 1:dim(df_w_yeo_volume_info_with_prop_of_network)[1]){
  df_w_yeo_volume_info_with_prop_of_network[subj, grepl(x = names(df_w_yeo_volume_info_with_prop_of_network), pattern = "_prop_net")] = df_w_yeo_volume_info_with_prop_of_network[subj, grepl(x = names(df_w_yeo_volume_info_with_prop_of_network), pattern = "_prop_net")]/sums_of_volume_of_healthy_fascicles_by_network
}

### rename the whole new data frame df_demo_and_fascicles
df_demo_and_fascicles <- df_w_yeo_volume_info_with_prop_of_network %>% 
  dplyr::select(-contains('_vol')) %>% #removes all columns with volume, leaving only the exam date, empi, and yeo values
  right_join(df_demo_and_fascicles, by = c("EXAM_DATE", "EMPI")) #combine with demo_and_fascicles

  

```


#summarize means across all fascicles
```{r make_summary_measures_of_fascicle_burden}

df_demo_and_fascicles <- df_demo_and_fascicles %>%
  mutate(total_fascicle_prop_lost_no_cranial_nerves = rowMeans(across(fascicle_names_w_prop_suffix))) %>%
  mutate(total_fascicle_volume_lost_no_cranial_nerves = rowMeans(across(fascicle_names_w_vol_suffix)))
```

#Compare disease burden by anxiety comorbidity
```{r compare_disease_burden_by_anxiety_comorbidity}

#lm
fascicle_number_of_anxiety_dx_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ number_of_anxiety_comorbidities_extended, list(i = as.name(x))), data = df_demo_and_fascicles)
})
names(fascicle_number_of_anxiety_dx_lm) <- fascicle_names_w_prop_suffix
fascicle_number_of_anxiety_dx_anova <- lapply(fascicle_number_of_anxiety_dx_lm, anova)

#fdr corrected
fascicle_number_of_anxiety_dx_anova_fdr <- fdr_anova_generic(fascicle_number_of_anxiety_dx_anova, 1)
print(fascicle_number_of_anxiety_dx_anova_fdr)

## limbic area disease by anxiety diagnosis

yeo_lim_no_anxiety <- lm(LIM~number_of_anxiety_comorbidities_extended, data = df_demo_and_fascicles) #nothing

```
#Has depression AND anxiety diagnoses
```{r compare_disease_burden_by_dep_AND_anxiety_comorbidity}

#lm
fascicle_depANDanx_dx_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ Has.depANDanx.dx, list(i = as.name(x))), data = df_demo_and_fascicles)
})
names(fascicle_depANDanx_dx_lm) <- fascicle_names_w_prop_suffix
fascicle_depANDanx_dx_anova <- lapply(fascicle_depANDanx_dx_lm, anova)

#fdr corrected
fascicle_depANDanx_dx_anova_fdr <- fdr_anova_generic(fascicle_depANDanx_dx_anova, 1)
print(fascicle_depANDanx_dx_anova_fdr)

```

#compare disease burden by psychiatric comorbidity
```{r compare_disease_burden_between_anxiety_and_no_psych_dx}

#lm
fascicle_number_of_psychiatric_dx_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ number_of_psychiatric_comorbidities_extended, list(i = as.name(x))), data = df_demo_and_fascicles)
})
names(fascicle_number_of_psychiatric_dx_lm) <- fascicle_names_w_prop_suffix

fascicle_number_of_psychiatric_dx_anova <- lapply(fascicle_number_of_psychiatric_dx_lm, anova)

#fdr corrected
fascicle_number_of_psychiatric_dx_anova_fdr <- fdr_anova_generic(fascicle_number_of_psychiatric_dx_anova, 1)
print(fascicle_number_of_psychiatric_dx_anova_fdr)


## yeo
#lm
psych_comorbidity_lm_yeo <- lapply(yeo_network_names, function(x) 
{
  lm(substitute(i ~ number_of_psychiatric_comorbidities_extended, list(i = as.name(x))), data = anxiety_vs_no_psych)
})
names(psych_comorbidity_lm_yeo) <- yeo_network_names

psych_comorbidity_yeo_anova <- lapply(psych_comorbidity_lm_yeo, anova)

#fdr corrected
psych_comorbidity_yeo_anova_fdr <- fdr_anova_generic(psych_comorbidity_yeo_anova, 1)
print(psych_comorbidity_yeo_anova_fdr)


```

##compare disease in anxiety versus patients with no psychiatric comorbidity
```{r anxiety_vs_healthy_ish}

anxiety_vs_no_psych <- df_demo_and_fascicles %>%
  mutate(anxietyGroupVar = ifelse(Has.anxietydx, 2, ifelse(healthy_ish, 1, 0))) %>% #complicated, if they have an anxiety disorder, they get a 2, if they are health-ish, no psych dx or meds, 1, otherwise, exclude
  filter(anxietyGroupVar != 0) %>% #get rid of the people who are not anxious and not healthy_ish, n =650, lost n=173
  filter(is.na(depGroupVar)) %>% #exclude people with depression (87 have both depression and anxiety), n = 563, anxiety = 101, nonanxious = 462)
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  slice(1) %>%
  ungroup


#lm
anxiety_vs_no_psych_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ anxietyGroupVar, list(i = as.name(x))), data = anxiety_vs_no_psych)
})
names(anxiety_vs_no_psych_lm) <- fascicle_names_w_prop_suffix

anxiety_vs_no_psych_lm_anova <- lapply(anxiety_vs_no_psych_lm, anova)

#fdr corrected
anxiety_vs_no_psych_lm_anova_fdr <- fdr_anova_generic(anxiety_vs_no_psych_lm_anova, 1)
print(anxiety_vs_no_psych_lm_anova_fdr)


## yeo
#lm
anxiety_vs_no_psych_lm_yeo <- lapply(yeo_network_names, function(x) 
{
  lm(substitute(i ~ anxietyGroupVar, list(i = as.name(x))), data = anxiety_vs_no_psych)
})
names(anxiety_vs_no_psych_lm_yeo) <- yeo_network_names

anxiety_vs_no_psych_yeo_anova <- lapply(anxiety_vs_no_psych_lm_yeo, anova)

#fdr corrected
anxiety_vs_no_psych_yeo_anova_fdr <- fdr_anova_generic(anxiety_vs_no_psych_yeo_anova, 1)
print(anxiety_vs_no_psych_yeo_anova_fdr)



```




## Depression versus healthy analysis

    
```{r demographics}

#this will display a demographics table comparing age, race, sex between healthy and depressed groups, using the first presentation to treatment

make_demographics_table_ms(data_frame = data_2023_pull)

df_unique_empi <- data_empi_acc_f_phq %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 

make_demographics_table_ms(data_frame = df_unique_empi)

df_just_healthy_and_depressed <- df_unique_empi %>% filter(depGroupVar != 0)

make_demographics_table_ms(data_frame = df_just_healthy_and_depressed)


#just people with good mimosa
df_good_mimosa <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
make_demographics_table_ms(data_frame = df_good_mimosa)

df_good_mimosa_unique <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 
make_demographics_table_ms(data_frame = df_good_mimosa_unique)
```


```{r proof_of_concept}

#this section creates histograms looking at the proportion of volume lost in each fascicle across subjects
#we recapitulate earlier work and show that higher volume loss with our method reflects regions previously known to have higher volume loss
#These findings suggest that the streamline filtering approach could be a reasonable approach for this analysis

#have to pull out just the pieces I'm interested in
just_dep_and_empi <- subset(data_empi_acc_f_phq, select = c("EMPI", "depGroupVar"))
added_dep_to_fascicles <- merge(just_dep_and_empi, fascicle_proportions, by = c("EMPI"))
melted_df <- melt(added_dep_to_fascicles, id.vars = c("EMPI", "EXAM_DATE", "depGroupVar"))

#exclude regions where there was no lesion at all
lesioned <- subset(melted_df, value > 0)

#only include people in healthy or depressed group
lesioned_dx <- subset(lesioned, depGroupVar != 0)

#separate out healthy and depressed
healthy <- subset(lesioned, depGroupVar == 1)
depressed <- subset(lesioned, depGroupVar == 2)

q<-ggplot(lesioned, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r<-ggplot(lesioned_dx, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r_color<-ggplot(lesioned_dx, aes(x=value, color=factor(depGroupVar))) + geom_histogram() + facet_wrap(~variable)
x<-ggplot(lesioned, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
y<-ggplot(healthy, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
z<-ggplot(depressed, aes(x=value)) + geom_histogram() + facet_wrap(~variable)

#print(q)
#print(r)
print(r_color)
#print(x)
#print(y)
#print(z)
```

```{r age_effects_fascicles_unique}
########### age effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


#### age histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$PAT_AGE_AT_EXAM,
main = paste0("Age In Good Mimosa Group : n = ", dim(dep_and_healthy_groups_for_ICD_analysis)[1]), xlab = "Age", breaks = 10)

#lm
fascicle_age_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_age_lm) <- fascicle_names

#anova
fascicle_age_anova <- lapply(fascicle_age_lm, anova)

#fdr corrected
fascicle_age_anova_fdr <- fdr_anova_generic(fascicle_age_anova, 1)
print(fascicle_age_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_age_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_age_lm,visreg)
visreg(fascicle_age_lm$AF_R,ylab = "Proportion of Affected Streamlines", xlab = "Age in Years",
       line=list(col="red"),
       points=list(col="black"))

```


```{r sex_effects_fascicles_unique}

### really not interesting at all. 3 areas that are uncorrected: SCP, CPT_O_R, OR_R

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sex_anova_p <- sapply(fascicle_sex_anova, function(v) v$"Pr(>F)"[1])
fascicle_sex_anova_p05_unc <- as.data.frame(fascicle_sex_anova_p[fascicle_sex_anova_p < 0.05])
print(fascicle_sex_anova_p05_unc)

```



```{r depression_unique_all_fascicles_together_in_dep_networks}

#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
   mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


dep_vs_healthy <- lm(total_fascicle_prop_lost ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy) #p=0.494, cohen d = 0.2


#power analysis to predict sample required for K, u = num df, v = denom df, f2=0.01 (cohen d = 0.02/2) 
#prop in each fascicle predicting dep (87), number of predictors (age, sex, ef, ess?) = 4, u = 87-4 = 83
pwr.f2.test(u=83, f2 = 0.02, sig.level = 0.5, power = 0.8)

#test whether proportion lost overall different between depressed and healthy- yes, p = 0.049
total_volume_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 27%, mean non_dep = 24%, p = 0.049


df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)

plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed"))

print(plot)

#bar plot
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)



#look at within depression network specifically - trend, p = 0.059
total_volume_lost_dep_vs_healthy_unique_in_dep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 36%, mean non_dep = 32%, p = 0.071

#look at within depression network in fascicles where at least 10% of the volume of the fascicle was in dep network
#yes, p = 0.048
total_volume_lost_dep_vs_healthy_unique_in_dep_network_10percent <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 33%, mean non_dep = 27%, p = 0.048

#look at within depression network in fascicles where at least 5% of the volume of the fascicle was in dep network
#yes, 
total_volume_lost_dep_vs_healthy_unique_in_dep_network_5percent <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 32%, mean non_dep = 27%, p = 0.056


#look at outside depression network, yes p = 0.037
total_volume_lost_dep_vs_healthy_unique_in_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 18%, mean non_dep = 16%, p = 0.037

### Age actually makes things worse
#dep_vs_healthy_w_age <- lm(total_fascicle_prop_lost ~ depGroupVar + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)
#summary(dep_vs_healthy_w_age)

#df for visreg - actually not using visreg. Just a nice way to see that there is significantly more loss in depression network versus outside depression network





```

```{r depressed_versus_healthy_unique_subjs_indiv_fascicle}
##### repeat above analysis but use only the first instance of each EMPI, sorted by date
df_unique_empi <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 


#lm
fascicle_lm_unique <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = df_unique_empi)
})
names(fascicle_lm_unique) <- fascicle_names

#anova
fascicle_anova_unique <- lapply(fascicle_lm_unique, anova)

#fdr corrected
fascicle_anova_unique_fdr <- fdr_anova_generic(fascicle_anova_unique, 1)
print(fascicle_anova_unique_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector ==2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 5% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_volumes_dep_network$prop_in_mask >= 0.05)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)


#uncorrected
fascicle_anova_unique_p <- sapply(fascicle_anova_unique, function(v) v$"Pr(>F)"[1])
fascicle_anova_unique_p05_unc <- as.data.frame(fascicle_anova_unique_p[fascicle_anova_unique_p < 0.05])
print(fascicle_anova_unique_p05_unc)

### plot AF_R 

df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)



plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  ggtitle("Arcuate Fasciculus R") + 
 # geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed")) 
  
print(plot)

### Plot OR_R	0.69024050
df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$OR_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$OR_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)



plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  ggtitle("Optic Radiation R") + 
 # geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed")) 
print(plot)


### grouped bar plot

Diagnosis <- c(rep("Depressed" , 2) , rep("Non-Depressed" , 2))
Fascicle <- rep(c("Depression Network (AF)" , "Region Outside Depression Network (C_PH)"), 2)
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]),
           mean(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1 ))),
          (sd(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1 ))))

data <- data.frame(Diagnosis,Fascicle,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)


# Grouped
barplot <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)


barplot2 <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity", colour = "black", width=0.9,size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1) + 
    scale_fill_manual(values = c("#cdcdcd", "#FFFFFF", "#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
 
    ylab("Proportion of Fascicles Affected") +
    theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
          axis.title.y = element_text(size=20),
          axis.line = element_line(size = 1.5, colour = "black", linetype=1),
          panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty graph
    scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph


print(barplot2)


```

```{r testing_whether_ms_disease_more_likely_in_depression_mask_unique}
### tests whether there is higher proportion of vertices lost in depression network versus not

dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ### when I filter and remove fascicles where there was no loss at all, the depression vs healthy findings go away
#  filter(total_fascicle_prop_lost > 0) %>%
  ungroup()


#test whether there is differentially more volume loss in depression versus nondepression network
volume_lost_dep_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep_net = 35%, mean non_dep_net =  17%, p 2.2 x 10^-16

volume_lost_dep10_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep net = 31%, mean non_dep_net = 17%, p 2.2 * 10^-16

volume_lost_dep5_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep net = 30%, mean non_dep_net = 17%, p 2.2 * 10^-16

#df for visreg - actually not using visreg. Just a nice way to see that there is significantly more loss in depression network versus outside depression network
df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "network")
df_for_visreg$network <- as.factor(df_for_visreg$network)

plot <- ggplot(df_for_visreg, aes(x=network, y = prop_lost, col=network)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="red") + 
  scale_x_discrete(labels=c("1" = "Depression Network", "2" = "Non-Depression Network")) + 
  ylab("Proportion of Fascicles Affected") + 
  theme(axis.text =element_text(size=14), axis.title.x = element_blank())
  
print(plot)

########## Bar plot
Network <- c("Depression Network","Non-Depression Network")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet)/sqrt(dim(dep_and_healthy_groups_for_ICD_analysis)[1])),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network)/sqrt(dim(dep_and_healthy_groups_for_ICD_analysis)[1])))

data <- data.frame(Network,value,sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Network,fill=Network, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)
# Black and white
barplot <- ggplot(data, aes(x=Network,fill=Network, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph


print(barplot)



###### Depression network x depression group interaction - It is there, depression always worse. 
#these lms largely match up with the t.tests above. Sig differences between depressed (more disease) within and outside of mask

loss_in_dep_network <- lm(total_fascicle_prop_lost_indepnet~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #non sig, p = 0.061
loss_in_dep_network_10_percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #p = 0.0492
loss_in_nondep_network <- lm(total_fascicle_prop_lost_nondep_network~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #p=0.037
```


```{r phq9_correlation_fascicles}

####### NOTHING SIGNIFICANT!!!! ########3
#isolate out only the depressed group and healthy group
with_phq9 <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0) %>%
  filter(!is.na(PHQ.9)) %>%
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.9, list(i = as.name(x))), data = with_phq9)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- fascicle_anova_p[!is.na(fascicle_anova_p) & fascicle_anova_p < 0.05]
print(fascicle_anova_p05_unc)


######### overall fascicle proportion affected - nothing is significant
overall_prop_affected <- lm(total_fascicle_prop_lost~PHQ.9, data=with_phq9)
overall_prop_affected_depnet <- lm(total_fascicle_prop_lost_indepnet~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_10percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_5percent <- lm(total_fascicle_prop_lost_indepnet_5_percent~PHQ.9, data=with_phq9)
overall_prop_affected_nondep <- lm(total_fascicle_prop_lost_nondep_network~PHQ.9, data=with_phq9)
```

```{r phq9_regressions_just_dep_group}
##### NOTHING SIGNIFICANT ########
##################################
## Just within depression group ##
##################################
#isolate out only the depressed group and healthy group
with_phq9 <- df_demo_and_fascicles %>%
  filter(depGroupVar == 2) %>%
  filter(!is.na(PHQ.9)) %>%
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()
#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.9, list(i = as.name(x))), data = with_phq9)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)


#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- fascicle_anova_p[!is.na(fascicle_anova_p) & fascicle_anova_p < 0.05]
print(fascicle_anova_p05_unc)

######### overall fascicle proportion affected - nothing is significant
overall_prop_affected <- lm(total_fascicle_prop_lost~PHQ.9, data=with_phq9)
overall_prop_affected_depnet <- lm(total_fascicle_prop_lost_indepnet~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_10percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_5percent <- lm(total_fascicle_prop_lost_indepnet_5_percent~PHQ.9, data=with_phq9)
overall_prop_affected_nondep <- lm(total_fascicle_prop_lost_nondep_network~PHQ.9, data=with_phq9)

#visreg
#sapply(fascicle_lm, visreg)
```
All the mixed models are below
```{r age_effects_indiv_fascicles_mm}

### This subscript compares proportion of fascicles lost across age for each fascicle of the 80+. Looks lonly at the people in the depressed versus healthy group. Importantly, I ran this looking at everyone, at the results are the same.
### Separately considers findings just within the association cortex

#isolate out only the depressed group and healthy group
df_mm <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
#n depressed = 859, healthy = 604, total n = 1463


#lm
fascicle_lm_mm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ PAT_AGE_AT_EXAM + (1 | EMPI), list(i = as.name(x))), data = df_mm)
})
names(fascicle_lm_mm) <- fascicle_names

#anova
fascicle_anova_mm <- lapply(fascicle_lm_mm, anova)

#fdr corrected
fascicle_anova_mm_fdr <- fdr_anova_generic(fascicle_anova_mm, 1)
print(fascicle_anova_mm_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_mm_p <- sapply(fascicle_anova_mm, function(v) v$"Pr(>F)"[1])
fascicle_anova_mm_p05_unc <- as.data.frame(fascicle_anova_mm_p[fascicle_anova_mm_p < 0.05])
print(fascicle_anova_mm_p05_unc)


```

```{r sex_effects_fascicles_mm}
########### sex effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0) 
#healthhy = 713, total n = 1106

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ osex + (1|EMPI), list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_sex_lm,visreg)
```

```{r depressed_versus_healthy_indiv_fascicles_mm}

### This subscript compares proportion of fascicles lost for each fascicle of the 80+ between those in the depressed and the clean healthy group. Done as both a mixed model as well as using unique individuals alone.

#Of note, adding age into this model makes things WORSE

### Separately considers findings just within the association cortex
#isolate out only the depressed group and healthy group
df_mm <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
#n depressed = 859, healthy = 604, total n = 1463


#lm
fascicle_lm_mm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ depGroupVar + (1 | EMPI), list(i = as.name(x))), data = df_mm)
})
names(fascicle_lm_mm) <- fascicle_names

#anova
fascicle_anova_mm <- lapply(fascicle_lm_mm, anova)

#fdr corrected
fascicle_anova_mm_fdr <- fdr_anova_generic(fascicle_anova_mm, 1)
print(fascicle_anova_mm_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_mm_p <- sapply(fascicle_anova_mm, function(v) v$"Pr(>F)"[1])
fascicle_anova_mm_p05_unc <- as.data.frame(fascicle_anova_mm_p[fascicle_anova_mm_p < 0.05])
print(fascicle_anova_mm_p05_unc)


```


Lastly, this section will explore interactions (age * dep), (sex * dep)

```{r age_by_depression_unique}

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_agedep_lm <- lapply(fascicle_names, function(x) 
{
   lm(substitute(i ~ PAT_AGE_AT_EXAM*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
# lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM + osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_agedep_lm) <- fascicle_names

#anova
fascicle_agedep_anova <- lapply(fascicle_agedep_lm, anova)


#fdr corrected - depression alone
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 2)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected - interaction
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 3)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_agedep_anova, function(v) v$"Pr(>F)"[3])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)
```

```{r sex_by_depression_unique}

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_sexdep_lm <- lapply(fascicle_names, function(x) 
{
   lm(substitute(i ~ osex*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)

})
names(fascicle_sexdep_lm) <- fascicle_names

#anova
fascicle_sexdep_anova <- lapply(fascicle_sexdep_lm, anova)


#fdr corrected - depression alone
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 2)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[2])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)

#fdr corrected - interaction
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 3)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[3])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)
```
Interaction models below

```{r sexdep_effects_fascicles_unique}

### Trying to figure out if there are any sex * depression effects, covarying for age given that men tend to get worse over time. dep*sex uncorrected in SLF1_L and CNVIII_R p< 0.05)

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sexdep_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ depGroupVar*osex + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sexdep_lm) <- fascicle_names

#anova
fascicle_sexdep_anova <- lapply(fascicle_sexdep_lm, anova)


##### depGroupVar ####
### 12 areas, nearly identical to reg model

#fdr corrected
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 1)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[1])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) ### CNVIII p < 0.05

##### sex differences ####
## same as above, just add in CNVIII_R

#fdr corrected
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 2)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[2])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) ### CNVIII p < 0.05


#######interaction ####

### SLF1_L and CNVIII_R

#fdr corrected interaction
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 4)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,4)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,4)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[4])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) #p uncorrected slf1_L p = 0.0488, CNVIII_R 0.01)


### grouped bar and line plot

Diagnosis <- c(rep("Depressed" , 2) , rep("Non-Depressed" , 2))
Sex <- rep(c("Male" , "Female"), 2)
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)]))


sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)))))
           

data <- data.frame(Diagnosis,Sex,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(fill=Sex, y=value, x=Diagnosis)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of SLF Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)

lineplot <- ggplot(data=data, aes(fill=Sex, y=value, x=Diagnosis, group = Sex)) + 

    geom_line(aes(color=Sex, size=0.9)) +
    geom_point(aes(color=Sex, size=0.9)) +
    ylim(0.05,0.30)+
    ylab("Proportion of SLF Affected") +
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1) + 
    theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank())
    
print(lineplot)



```
