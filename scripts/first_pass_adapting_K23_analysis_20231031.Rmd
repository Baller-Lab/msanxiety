---
title: "MS Prelim Data K23"
author: "Erica Baller"
date: "2/25/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(visreg)
library(lme4)
library(lmerTest)
library(ggplot2)
library(reshape2)
library(pwr)
library(mgcv)
library(stringr)
library(MatchIt)
library(ggpubr)
library(tidymv)
#functions
source("~/BBL/msanxiety/scripts/ms_functions.R")
```

## MS anxiety analyses

## R Markdown

The first chunk here is reading in appropriate data frames and preprocessing. Two big data frames are read in. The first is the demographic, drug, lab info for the MS patients (from the DAC pull). The second is the data frame of fascicle proportion affected for people with good mimosa (# volume affected/total volume of fascicle). The most important preprocessing occurs in a series of mutate commands. These essentially add new columns to the data frame that can later be used. The thrust of these mutate commands is to define who has depression and who does not.

Of note, in prior iterations of this analysis, we did not consider psychiatric medications in determining group inclusion/exclusion. Turns out it makes a difference, as a lot of people on psychotropic medications were counted as "controls/healthy" in previous analyses. For these preliminary analysis, our inclusion/exclusion are more stringent. Of note, the graph below is irrespective of whether they had good/bad MIMoSA. As such, the MIMoSA subset is smaller. It does however highlight the

<img width="70%" src="/Users/eballer/BBL/msdepression/data/drugs_data/MS_Patient_Depression_Categorizations.png"/>


Inclusion criteria below:

Inclusion MS Criteria (dataframe read in here has already been filtered down using the exclusions below previously)
  1) Scanned under MS protocol (42K)
  2) MS Diagnosis (17K)
  3) Seen by MS doctor (16K)
  
Inclusion criteria for Anxious Group
  1) Have an ICD10 F3* code (in our sample, people have F41.1; 41.3; 41.8; 41.9)
        (may use this later)- https://www.nami.org/About-Mental-Illness/Treatments/Mental-Health-Medications
        
Inclusion criteria for Healthy Group
  1) No F* diagnoses
  2) At least 1 PHQ2 or PHQ9 with a documented 0
  3) Free of psychiatric medications per NAMI website

Exclusions
  If you received the MS protocol or had a diagnosis of MS but never actually saw an MS provider, we cannot be sure that the diagnosis of MS is truly valid, as it is hard to diagnose anyway.
  If you did not have a diagnosis of depression and never completed a PHQ2 or 9, and had no history of medications, we could not safely confirm nor deny the presence of depression. These subjects were excluded from future analyses. We could consider adding these to the healthy group maybe, but not too inclined to do that right now. 

Imaging exclusion
  We are currently only using people who had good MIMOSA (75 or 100). That severely limits our numbers, but that is okay! When we re-QC, we will probably get a lot more into this group.

Final N demographics 

  
(unique, with good MIMoSA):



### testing mean UF in depression group  - NS!!!
(previous script (~/BBL/msdepression/scripts/Biological_Psychiatry_Revision_Scripts/msdepression_n380_started_20230927_mm_BP_r1.Rmd)), lines 734 and  779-781
  #bilat: depGroupVar        85.32     206.70   t=0.413    p=0.680    
  disease_mean_UF_vol_lm <- lm(mean_UF_vol ~ depGroupVar + osex+PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)
  summary(disease_mean_UF_vol_lm)
#findings


```{r read_in_df}
homedir <- "/Users/eballer/BBL/msanxiety/"

#open Rds
data_2023_pull <- readRDS(paste0(homedir, "/data/data_2023_pull_with_curated_icd10_codes.rds"))
```

```{r read_in_mimosa_qc}
#This section checks how many unique individuals had QA data, and then how many met MIMoSA QC. Some additional people lost at registration. 

#1 Total unique individuals who also have MS - 890
#2 Total unique who had good MIMoSA - 786
#3 Total unique with bad MIMoSA - 890-786 = 104
#4 Total lost in streamline filtering - 3
#5 Final N going into inclusion/exclusion - 783

#read in mimosa data
mimosa_qc <- read.csv("/Users/eballer/BBL/msdepression/data/melissa_martin_files/csv/mimosa_dataframe", sep = ",", header = FALSE) #n=2840

#preprocess data frame to extract dates, empis, and score
empis_with_qc <- mimosa_qc %>% 
  mutate(EMPI = as.factor(gsub(x = V5, pattern = ".*sub-(.*)/ses-.*/.*", replacement="\\1", perl = TRUE))) %>%
  mutate(EXAM_DATE = gsub(x=V5, pattern = ".*/ses-(.{8})/.*", replacement = "\\1\\2\\3")) %>% 
  mutate(score = V3) 

#merge with whole data frame to make sure we exclude people w/out MS
mimosa_qc_df <- merge(data_2023_pull, empis_with_qc, by = c("EMPI", "EXAM_DATE")) #n = 3592

#get list of unique patients, n = 890
mimosa_qc_unique <- mimosa_qc_df %>%
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  slice(1) %>%
  ungroup #n=890
  
#get list of unique patients with good QC, n = 867
mimosa_unique_score_gre_75 <- mimosa_qc_unique %>%
  filter(score >= 75) %>%
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  mutate(EXAM_DATA = as.character(EXAM_DATE)) %>%
  mutate(EMPI = as.character(EMPI)) %>%
  dplyr::select(EMPI, EXAM_DATE, score) %>%
  slice(1) %>%
  ungroup 
```

```{r merge_df_with_mimosa}

#n=867, individual scans
df_people_with_good_mimosa <- data_2023_pull %>% 
  group_by(EMPI, EXAM_DATE) %>%
  slice(1) %>%
  left_join(mimosa_unique_score_gre_75, by = c("EMPI", "EXAM_DATE")) %>%
  filter(!is.na(score))
```



### Read in fascicle info, use this to determine proportion and volume of injury within each fascicle, and save it in the df_demo_and_fascicles_df
```{r read_in_fascicle_info}

### by the end of this chunk, the df should include 77 columns each for proportion of injury and volume of injury in each fascicle

##########################################################
#             Read in Fascicle info             #
##########################################################

fascicle_proportions <- read.csv(paste0("/Users/eballer/BBL/msdepression//results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336
fascicle_proportions <- fascicle_proportions %>%
  mutate(EMPI = as.character(EMPI)) %>%
  mutate(EXAM_DATE = as.character(EXAM_DATE))

```

## Merge data with good mimosa
```{r merge_with_good_mimosa}
##########################################################
#             Merge with data_empi              #
##########################################################

 #n = 812
df_demo_and_fascicles <- df_people_with_good_mimosa %>% 
  left_join(fascicle_proportions, by = c("EMPI", "EXAM_DATE")) %>%
  filter(!is.na(Has.MS.Provider)) %>% #remove people who don't have MS provider
  filter(!is.na(CNII_L)) #this is a sample fascicle that should have a value. if it does not, it means something is usually wrong with whole person. Remove rows with NAs


```

## Read in lesion volume size
```{r read_in_lesion_volumes}
##########################################################
#             Read in Lesion Volumes                     #
##########################################################

# contains the volume of lesioned voxels, i.e. a sum of all the areas of each individual's binary mask that are 1

lesion_volumes <- read.csv("/Users/eballer/BBL/msdepression/results/mimosa_binary_masks_hcp_space_20211026_n2336_volumes", sep = ",", header = TRUE) #n=958 unique, identical to fascicle unique
lesion_volumes <- lesion_volumes %>%
  mutate(EMPI = as.character(EMPI)) %>%
  mutate(EXAM_DATE = as.character(EXAM_DATE))

```

## Merge with data frame with good mimosas
```{r merge_lesion_volume_w_mimosa_df}
##########################################################
#             Merge lesion volumes with mimosa df        #
##########################################################
#merge whole data set with fascicle proportions, n = 812
df_demo_and_fascicles <- df_demo_and_fascicles %>%
  left_join(lesion_volumes, by = c("EMPI", "EXAM_DATE")) 


```

## Make separate columns for proportional injury (prop), total volume injury (vol)
```{r add_suffix_to_each_measure}

########################################
## Read in Fiber Volume Values        ##
########################################

#read in fiber volume values
fiber_volume_values <- read.csv("/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fiber_volume_values.csv", sep=",", header = T)


#########################################
## Get vectors with names of fascicles ##
#########################################

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
fascicle_names_no_cranial_nerves <- fascicle_names[grep("CN", fascicle_names, invert = TRUE)] #n=77, drop cranial nerves

fascicle_names_w_prop_suffix <- gsub(pattern = "(.*)", replacement = "\\1_prop", perl=TRUE, x = fascicle_names_no_cranial_nerves)
fascicle_names_w_vol_suffix <- gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE, x = fascicle_names_no_cranial_nerves)


#write.table(fascicle_names,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names.csv", row.names = F, quote = F, col.names = F)


##########################################################
#  Add columns for volume and change proportion names    #
##########################################################


#remove cranial nerves
fiber_volume_values_no_cranial_nerves <- fiber_volume_values %>% filter(fascicle %in% fascicle_names_no_cranial_nerves) %>%
  slice(order(factor(fascicle, levels = fascicle_names_no_cranial_nerves)))


#extract data frame that only includes the fascicle proportion lost
df_fascicles_prop <- df_demo_and_fascicles[ , (names(df_demo_and_fascicles) %in% fascicle_names_no_cranial_nerves)] 
df_everything_else <- df_demo_and_fascicles[ , !(names(df_demo_and_fascicles) %in% fascicle_names_no_cranial_nerves)]

#multiply each row by the vector of total volumes to extract volume of disease within fascicle
df_fascicles_volumes <- sweep(x = df_fascicles_prop, MARGIN = 2,                        # Sweep with Complex STATS
                  STATS = fiber_volume_values_no_cranial_nerves$volume_full, FUN = "*") %>%
  mutate_if(is.numeric, round) #round all values

# change name of df_fascicle_volumes to have the suffix, and add a suffix for the proportion measures
names(df_fascicles_prop) <- fascicle_names_w_prop_suffix
names(df_fascicles_volumes) <- fascicle_names_w_vol_suffix


#combine back with data_fram
#df_demo_and_fascicle_volumes_full <- cbind(df_everything_else, df_fascicle_volumes)
df_demo_and_fascicles <- cbind(df_everything_else, df_fascicles_prop, df_fascicles_volumes)
```

##YEO Networks
###Read in fascicle info
```{r read_in_yeo_fascicle_info}
##########################################################
#             Read in Fascicle info             #
##########################################################
########
#fascicle volumes in yeo networks
########

#read in file with proportions
#fascicle_volumes_yeo_7 <- read.csv(paste0(homedir, "results/yeo_7_network_overlap_proportions.txt"), header = T, sep = ",", na.strings="0")

#make titles nice
#names(fascicle_volumes_yeo_7) <-gsub("prop_in_mask_", "prop_", names(fascicle_volumes_yeo_7))

#make Nas into 0
#fascicle_volumes_yeo_7[is.na(fascicle_volumes_yeo_7)]=0

#read in file with binarized yes/no 
fascicle_volumes_yeo_7_binarized <- read.csv("/Users/eballer/BBL/msdepression/results/yeo_7_network_overlap_proportions_binarized.txt", header = T, sep = ",")

#drop cranial nerves
fascicle_volumes_yeo_7_binarized_no_cranial_nerves <- fascicle_volumes_yeo_7_binarized %>% filter(!grepl('CN', fascicle))

#check that order of df is same as yeo networks
new_df <- gsub(pattern = "_vol", replacement = "", x = names(df_demo_and_fascicles[grep(pattern = "_vol", x = names(df_demo_and_fascicles))]))

combined_df <- data.frame(cbind(new_df, fascicle_volumes_yeo_7_binarized_no_cranial_nerves$fascicle))
names(combined_df) <- c("df", "yeo")

#they match
combined_df$match <- combined_df$df == combined_df$yeo
```

### Calc healthy volume of yeo networks
```{r calc_healthy_volume_of_yeo_networks}
#multiply with the binary yeo maps to get absolute volumes of healthy
fascicle_volumes_yeo_7_full_volumes <- fascicle_volumes_yeo_7_binarized_no_cranial_nerves %>% 
  tibble::remove_rownames() %>%
  tibble::column_to_rownames(var = 'fascicle') %>%
  mutate(across(everything()) * fiber_volume_values_no_cranial_nerves$volume_full) %>%
  rename_with(~ str_c(.x, "_vol"), everything()) 

#sum the volumes of each network to get total. 
sums_of_volume_of_healthy_fascicles_by_network <- fascicle_volumes_yeo_7_full_volumes %>%
  summarise(across(everything(), ~ sum(., na.rm = TRUE)))

```

###Calculate injury to yeo networks for each subject
```{r calculate_injury_to_network}

#grab names of networks, get rid of first element which is "fasiscle"
yeo_network_names <- names(fascicle_volumes_yeo_7_binarized_no_cranial_nerves)[-1] 

#make names with _prop_net for use later to grap columns of proportions and not volumes
yeo_network_names_prop <- paste(yeo_network_names, 'prop_net', sep = '_')

df_w_yeo_volume_info <- df_demo_and_fascicles %>%
  # mutate(total_fascicle_vol_lost = rowMeans(across(all_of(fascicle_names_w_vol_suffix)))) %>%
  dplyr::select(EMPI, ends_with("_vol")) %>%
  ungroup()

#add columns to data frame for each network
df_w_yeo_volume_info[,yeo_network_names] = 0

#this has been checked with eyeballs and works. You CAN trust the df_w_yeo_volume_info
for (network in yeo_network_names) {

  for (subj in 1:dim(df_w_yeo_volume_info)[1]) {
      # multiply the binary vector of the network with the fascicle volumes of injury, sum, and store in data frame
      text_to_eval <- paste0("df_w_yeo_volume_info$", network,"[", subj,"]=sum(fascicle_volumes_yeo_7_binarized_no_cranial_nerves$", network,
      "*df_w_yeo_volume_info[",subj,",3:(dim(df_w_yeo_volume_info)[2] - 7)])")
     # print(text_to_eval)
      eval(parse(text=text_to_eval))
  }
}

### going to add 7 more columns to the data frame that contain the volume of injury/total healthy volume
df_w_yeo_volume_info_with_prop_of_network <- tibble(df_w_yeo_volume_info) %>% 
  mutate(across(all_of(yeo_network_names), 
    .names = "{.col}_prop_net"
    
  ))

#go through each subject, and divide their total volume of injury within each network by the overall volume of the network
for (subj in 1:dim(df_w_yeo_volume_info_with_prop_of_network)[1]){
  df_w_yeo_volume_info_with_prop_of_network[subj, grepl(x = names(df_w_yeo_volume_info_with_prop_of_network), pattern = "_prop_net")] = df_w_yeo_volume_info_with_prop_of_network[subj, grepl(x = names(df_w_yeo_volume_info_with_prop_of_network), pattern = "_prop_net")]/sums_of_volume_of_healthy_fascicles_by_network
}

### rename the whole new data frame df_demo_and_fascicles
df_demo_and_fascicles <- df_w_yeo_volume_info_with_prop_of_network %>% 
  dplyr::select(-contains('_vol')) %>% #removes all columns with volume, leaving only the exam date, empi, and yeo values
  right_join(df_demo_and_fascicles, by = c("EXAM_DATE", "EMPI")) #combine with demo_and_fascicles

  

```
##Anxiety Network from neurosynth (association, not uniformity)
###read in file with fasciclexanxiety overlap, and define anxiety network
```{r read_in_neurosynth_anxiety_network}
neurosynth_anxiety_network_fascicle_overlap <- read.csv("/Users/eballer/BBL/msanxiety/results/streamline_volume_within_anxiety_network_association_neuro_maps_FDR_01.csv", header = T, sep = ",") %>% 
  filter(fascicle %in% fascicle_names_no_cranial_nerves) %>%
  slice(order(factor(fascicle, levels = fascicle_names_no_cranial_nerves))) %>% #get rid of cranial nerves up front 
  replace(is.na(.), 0)

fascicles_with_any_anxiety_overlap <- neurosynth_anxiety_network_fascicle_overlap %>%
  filter(prop_in_mask > 0)  #n = 43

#top 25% 
#number_of_brain_regions_in_top_25 <- round((dim(fascicles_with_any_anxiety_overlap)[1]/4)) #n=11
number_of_brain_regions_in_top_25 <- round((dim(neurosynth_anxiety_network_fascicle_overlap)[1]/4)) #n=19

fascicles_with_vol_top_25_percent_anxiety_overlap <- neurosynth_anxiety_network_fascicle_overlap %>%
  filter(!is.na(prop_in_mask)) %>%
  arrange(desc(non_zero_voxels_in_anxiety_map)) %>%
  slice(1:number_of_brain_regions_in_top_25)
  
fascicles_with_prop_top_25_percent_anxiety_overlap <- neurosynth_anxiety_network_fascicle_overlap %>%
  filter(!is.na(prop_in_mask)) %>%
  arrange(desc(prop_in_mask)) %>%
  slice(1:number_of_brain_regions_in_top_25)


#name vectors to use later
fascicle_names_any_anxiety_overlap_vol <- fascicles_with_any_anxiety_overlap$fascicle 
fascicle_names_top_25_vol <- fascicles_with_vol_top_25_percent_anxiety_overlap$fascicle 
fascicle_names_bottom_75_vol <- neurosynth_anxiety_network_fascicle_overlap %>% filter(!(fascicle %in% fascicle_names_top_25_vol)) %>% pull(fascicle)

fascicle_names_any_anxiety_overlap_prop <- fascicles_with_any_anxiety_overlap$fascicle
fascicle_names_top_25_prop <-fascicles_with_prop_top_25_percent_anxiety_overlap$fascicle 
fascicle_names_bottom_75_prop <- neurosynth_anxiety_network_fascicle_overlap %>% filter(!(fascicle %in% fascicle_names_top_25_prop)) %>% pull(fascicle)

##add vol/prop
fascicle_names_any_anxiety_overlap_vol_w_suff <- fascicle_names_any_anxiety_overlap_vol %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE)
fascicle_names_top_25_vol_w_suff <- fascicle_names_top_25_vol %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE)
fascicle_names_bottom_75_vol_w_suff <- fascicle_names_bottom_75_vol  %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE) #take fascicles not in 

fascicle_names_any_anxiety_overlap_prop_w_suff <- fascicle_names_any_anxiety_overlap_prop %>% gsub(pattern = "(.*)", replacement = "\\1_prop", perl=TRUE)
fascicle_names_top_25_prop_w_suff <- fascicle_names_top_25_prop %>% gsub(pattern = "(.*)", replacement = "\\1_prop", perl=TRUE)
fascicle_names_bottom_75_prop_w_suff <- fascicle_names_bottom_75_prop %>% gsub(pattern = "(.*)", replacement = "\\1_prop", perl=TRUE) 


# Total volume of injury within each anxiety network, double checked that : top_25_total_volume + bottom_75_total_volume
total_fascicle_volume <- sum(neurosynth_anxiety_network_fascicle_overlap$num_voxels_total)
any_anxiety_overlap_total_volume <- sum(fascicles_with_any_anxiety_overlap$num_voxels_total) # vol = 1093606
top_25_total_volume <-sum(fascicles_with_vol_top_25_percent_anxiety_overlap$num_voxels_total) # vol = 548305
bottom_75_total_volume <- sum(neurosynth_anxiety_network_fascicle_overlap$num_voxels_total[neurosynth_anxiety_network_fascicle_overlap$fascicle %in% fascicle_names_bottom_75_vol]) #vol = 548305

### Sort all the fascicles by %overlap, in decreasing order (so highest overlap at the top), and then take names of the top quartile, save for making binary maps later
anxiety_network_names_top_quartile_no_cranial_nerves<- (neurosynth_anxiety_network_fascicle_overlap[order(neurosynth_anxiety_network_fascicle_overlap$non_zero_voxels_in_anxiety_map, decreasing = TRUE),])$fascicle[1:number_of_brain_regions_in_top_25] 

write.table(anxiety_network_names_top_quartile_no_cranial_nerves, paste0(homedir, "/results/anxiety_network_names_top_quartile_no_cranial_nerves_by_vol.txt"), row.names = F, col.names = F, quote = F)

df_for_making_binary_color_maps_vol <- neurosynth_anxiety_network_fascicle_overlap %>% dplyr::select(fascicle, non_zero_voxels_in_anxiety_map)

write.table(df_for_making_binary_color_maps_vol, paste0(homedir, "/results/volume_of_overlap_w_anxiety_net_n77.csv"), row.names = F, col.names = F, quote = F, sep = ",")

df_for_making_binary_color_maps_prop <- neurosynth_anxiety_network_fascicle_overlap %>% dplyr::select(fascicle, prop_in_mask)

write.table(df_for_making_binary_color_maps_prop, paste0(homedir, "/results/proportion_of_overlap_w_anxiety_net_n77.csv"), row.names = F, col.names = F, quote = F, sep = ",")

```

### Get dep network data
```{r depression_network_injury}
#take depression network from the BP paper, and find names of fascicles in each group

#read in depression network overlap by volume data frame
dep_net_overlap_from_bp_paper <- read.csv("/Users/eballer/BBL/msdepression/results/df_fascicles_sorted_by_volume_in_mask_for_eTable3.csv", sep = ",", header = TRUE)

dep_net_top_25_percent <- dep_net_overlap_from_bp_paper$fascicle[1:round((dim(dep_net_overlap_from_bp_paper)[1]/4),0)]
dep_net_top_25_percent_w_suff <- dep_net_top_25_percent %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE)

top_25_total_volume_dep <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[1:round((dim(dep_net_overlap_from_bp_paper)[1]/4),0)])

nondep_net_bottom_75_percent <- dep_net_overlap_from_bp_paper$fascicle[(round(dim(dep_net_overlap_from_bp_paper)[1]/4,0) +1):dim(dep_net_overlap_from_bp_paper)[1]]
nondep_net_bottom_75_percent_w_suff <- nondep_net_bottom_75_percent %>%gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE)

bottom_75_total_volume_nondep <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[(round(dim(dep_net_overlap_from_bp_paper)[1]/4,0) +1):dim(dep_net_overlap_from_bp_paper)[1]])

```

### find names of fascicles in anxiety + dep network, unique to dep net, and unique to anxiety net
```{r find_names_and_overlaps_of_dep_and_anxiety_networks}

#I want to figure out what the volume is in all voxels within the overlap of depression and anxiety network, as well as within the nonoverlapping networks
#the depression net overlap from bp paper contains a colum (num_voxels_total) that has the full voxel sizes of all of the fascicles. Will use this to help find the "total volume size"

#total volume = 1545449
#checked to make sure that dep_only_net_vol + anxiety_only_net_vol + dep_and_anxiety_net_overlap_net_volume = dep_and_anxiety_net_unique_net_volume

dep_and_anxiety_combined <- c(fascicle_names_top_25_vol, dep_net_top_25_percent) #n = 38

dep_and_anxiety_net_unique_names <- dep_and_anxiety_combined %>% unique() #n=34
dep_and_anxiety_net_unique_net_volume <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[dep_net_overlap_from_bp_paper$fascicle %in% dep_and_anxiety_net_unique_names]) #vol = 1048643

dep_and_anxiety_net_overlap_names <- dep_and_anxiety_combined[dep_and_anxiety_combined %>% duplicated()] #n=4
dep_and_anxiety_net_overlap_net_volume <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[dep_net_overlap_from_bp_paper$fascicle %in% dep_and_anxiety_net_overlap_names]) #vol = 486260

dep_and_anxiety_net_overlap_names_no_CC <- dep_and_anxiety_net_overlap_names[dep_and_anxiety_net_overlap_names != "CC"]
dep_and_anxiety_net_overlap_net_volume_no_CC <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[dep_net_overlap_from_bp_paper$fascicle %in% dep_and_anxiety_net_overlap_names_no_CC]) #vol = 95659

dep_only_names <- dep_and_anxiety_net_unique_names[!(dep_and_anxiety_net_unique_names %in% fascicle_names_top_25_vol)] #n=15
dep_only_net_vol <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[dep_net_overlap_from_bp_paper$fascicle %in% dep_only_names]) #vol = 370747

anxiety_only_names <-dep_and_anxiety_net_unique_names[!(dep_and_anxiety_net_unique_names %in% dep_net_top_25_percent)] #n=15
anxiety_only_net_vol <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[dep_net_overlap_from_bp_paper$fascicle %in% anxiety_only_names]) #vol = 191636

### add suffix
dep_and_anxiety_net_unique_names_w_suff <- dep_and_anxiety_net_unique_names  %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE) #take fascicles not in 

dep_and_anxiety_net_overlap_names_w_suff <- dep_and_anxiety_net_overlap_names %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE) #take fascicles not in 

dep_and_anxiety_net_overlap_names_w_suff_no_CC <- dep_and_anxiety_net_overlap_names_no_CC %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE) #take fascicles not in 

dep_only_names_w_suff <- dep_only_names %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE) #take fascicles not in 

anxiety_only_names_w_suff <- anxiety_only_names %>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE) #take fascicles not in 
```

### Define anxiety net by top 25 in both vol/prop
```{r defineanxietynet_with_25_propx25vol}
##### make an array of fascicles that have both substantial overlap with the anxiety network (top 25% vol), and where each fascicle is substantially impacted (top 25% proportion), n = 14
fascicle_names_top_25_vol_x_top_25_prop <- fascicle_names_top_25_vol[fascicle_names_top_25_vol %in% fascicle_names_top_25_prop]

#add vol/prop suffixes
fascicle_names_top_25_vol_x_top_25_prop_PROP_suffix <-fascicle_names_top_25_vol_x_top_25_prop%>% gsub(pattern = "(.*)", replacement = "\\1_prop", perl=TRUE)
fascicle_names_top_25_vol_x_top_25_prop_VOL_suffix <-fascicle_names_top_25_vol_x_top_25_prop%>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE)

#create fascicle vectors that don't include these special fascicles, n = 63
fascicle_names_NOT_top_25_vol_x_top_25_prop <- fascicle_names_no_cranial_nerves[!(fascicle_names_no_cranial_nerves %in% fascicle_names_top_25_vol_x_top_25_prop)]

#add vol/prop suffixes
fascicle_names_NOT_top_25_vol_x_top_25_prop_PROP_suffix <- fascicle_names_NOT_top_25_vol_x_top_25_prop%>% gsub(pattern = "(.*)", replacement = "\\1_prop", perl=TRUE)
fascicle_names_NOT_top_25_vol_x_top_25_prop_VOL_suffix <- fascicle_names_NOT_top_25_vol_x_top_25_prop%>% gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE)

#anxiety25_propxvol overlap total, sum of these two is 1545449 (and this is total_fascicle_volume)
anxiety_top_25_vol_x_top_25_prop_vol <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[dep_net_overlap_from_bp_paper$fascicle %in% fascicle_names_top_25_vol_x_top_25_prop]) #vol = 181869

#nonanxiety25_propxvol overlap total
anxiety_NOT_top_25_vol_x_top_25_prop_vol <- sum(dep_net_overlap_from_bp_paper$num_voxels_total[dep_net_overlap_from_bp_paper$fascicle %in% fascicle_names_NOT_top_25_vol_x_top_25_prop]) #vol = 1363580

#check sums
if ((anxiety_top_25_vol_x_top_25_prop_vol + anxiety_NOT_top_25_vol_x_top_25_prop_vol) == total_fascicle_volume) {
  print("anxiety + nonanxiety net = total fascicle volume")
} else{
  print("something is wrong with counts")
}
  
```

###Add columns in the main data frame indicating overall injury in the whole network, in the top 25 network (vol and prop), and bottom 75%
```{r add_anxiety_and_dep_network_details_to_data_frame}

#all of this has been checked - making sure prop * vol network = sum of damage

df_demo_and_fascicles <- df_demo_and_fascicles %>%
  
  
  mutate(mean_fascicle_prop_lost_no_cranial_nerves = rowMeans(across(all_of(fascicle_names_w_prop_suffix)))) %>%
  mutate(mean_fascicle_volume_lost_no_cranial_nerves = rowMeans(across(all_of(fascicle_names_w_vol_suffix)))) %>%

  #sum of total volume lost and proportion of volume lost 
  mutate(sum_fascicle_vol_lost = rowSums(across(all_of(fascicle_names_w_vol_suffix)))) %>%
  mutate(proportion_volume_lost_per_total_network_size_sum = sum_fascicle_vol_lost/total_fascicle_volume) %>%
  
  #sum of total volume lost in anxiety network and proportion of volume lost in anxiety network (volume lost/network volume size) 
  mutate(sum_fascicle_vol_lost_inanxietynet_all = 
           rowSums(across(all_of(fascicle_names_any_anxiety_overlap_vol_w_suff)))) %>%
  mutate(proportion_volume_lost_anxiety_net_by_network_size_sum = sum_fascicle_vol_lost_inanxietynet_all/any_anxiety_overlap_total_volume) %>%
 
  
  #sum of total volume lost in anxiety network and proportion of volume lost in anxiety network (volume lost/network volume size) top quartile
  mutate(sum_fascicle_vol_lost_inanxietynet_top_quartile = 
           rowSums(across(all_of(fascicle_names_top_25_vol_w_suff)))) %>%
  mutate(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 = sum_fascicle_vol_lost_inanxietynet_top_quartile/top_25_total_volume) %>%
 
  #sum of total volume lost in nonanxiety network and proportion of volume lost in anxiety network (volume lost/network volume size) bottom 3 quartiles
  mutate(sum_fascicle_vol_lost_nonanxiety_net_bottom_3_quartiles = 
           rowSums(across(all_of(fascicle_names_bottom_75_vol_w_suff)))) %>%
  mutate(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 = sum_fascicle_vol_lost_nonanxiety_net_bottom_3_quartiles/bottom_75_total_volume) %>%
  
  ##sum of total volume lost in depression network and proportion of volume lost in depression network (volume lost/network volume size) top quartile
  mutate(sum_fascicle_vol_lost_indepressionnet_top_quartile = 
           rowSums(across(all_of(dep_net_top_25_percent_w_suff)))) %>%
  mutate(proportion_volume_lost_depression_net_by_network_size_sum_top_25 = sum_fascicle_vol_lost_indepressionnet_top_quartile/top_25_total_volume_dep) %>%

  #sum of total volume lost in nondepression network and proportion of volume lost in depression network (volume lost/network volume size) bottom 3 quartiles
  mutate(sum_fascicle_vol_lost_nondepression_net_bottom_3_quartiles = 
           rowSums(across(all_of(nondep_net_bottom_75_percent_w_suff)))) %>%
  mutate(proportion_volume_lost_nondepression_net_by_network_size_sum_bottom_75 = sum_fascicle_vol_lost_nondepression_net_bottom_3_quartiles/bottom_75_total_volume_nondep) %>%

  ##sum of total volume lost in depression + anxiety network and proportion of volume lost in network (volume lost/network volume size) top quartile
  mutate(sum_fascicle_vol_lost_indep_and_anxiety_net_combined = 
           rowSums(across(all_of(dep_and_anxiety_net_unique_names_w_suff)))) %>%
  mutate(proportion_fascicle_vol_lost_indep_and_anxiety_net_combined = sum_fascicle_vol_lost_indep_and_anxiety_net_combined/dep_and_anxiety_net_unique_net_volume) %>%
 
  ##sum of total volume lost in areas of overlap between depression + anxiety network and proportion of volume lost in network (volume lost/network volume size) top quartile
  mutate(sum_fascicle_vol_lost_indep_and_anxiety_net_overlap = 
           rowSums(across(all_of(dep_and_anxiety_net_overlap_names_w_suff)))) %>%
  mutate(proportion_fascicle_vol_lost_indep_and_anxiety_net_overlap = sum_fascicle_vol_lost_indep_and_anxiety_net_overlap/dep_and_anxiety_net_overlap_net_volume) %>%
  
  ##sum of total volume lost in areas of overlap between depression + anxiety network and proportion of volume lost in network (volume lost/network volume size), no CC
  mutate(sum_fascicle_vol_lost_indep_and_anxiety_net_overlap_no_CC = 
           rowSums(across(all_of(dep_and_anxiety_net_overlap_names_w_suff_no_CC)))) %>%
  mutate(proportion_fascicle_vol_lost_indep_and_anxiety_net_overlap_no_CC = sum_fascicle_vol_lost_indep_and_anxiety_net_overlap_no_CC/dep_and_anxiety_net_overlap_net_volume_no_CC) %>%
  
  ##sum of total volume lost in depression, no overlap with anxiety network and proportion of volume lost in network (volume lost/network volume size) top quartile
  mutate(sum_fascicle_vol_lost_indepressionnet_no_anxiety_overlap = 
           rowSums(across(all_of(dep_only_names_w_suff)))) %>%
  mutate(proportion_fascicle_vol_lost_indepressionnet_no_anxiety_overlap = sum_fascicle_vol_lost_indepressionnet_no_anxiety_overlap/dep_only_net_vol) %>%
  
    ##sum of total volume lost in anxiety, no depression overlap network and proportion of volume lost in network (volume lost/network volume size) top quartile
  mutate(sum_fascicle_vol_lost_inanxietynet_no_depression_overlap = 
           rowSums(across(all_of(anxiety_only_names_w_suff)))) %>%
  mutate(proportion_fascicle_vol_lost_inanxietynet_no_depression_overlap = sum_fascicle_vol_lost_inanxietynet_no_depression_overlap/anxiety_only_net_vol) %>%
  
    ##sum of total volume lost in anxiety 25 volxanxiety25prop groups, and proportion of volume lost in network (volume lost/network volume size)
  mutate(sum_fascicle_names_top_25_vol_x_top_25_prop = 
           rowSums(across(all_of(fascicle_names_top_25_vol_x_top_25_prop_VOL_suffix)))) %>%
  mutate(proportion_fascicle_vol_lost_top_25_vol_x_top_25_prop = sum_fascicle_names_top_25_vol_x_top_25_prop/anxiety_top_25_vol_x_top_25_prop_vol) %>%
  
    ##sum of total volume lost in remaining 63 fascicles NOT in anxiety 25 volxanxiety25prop groups, and proportion of volume lost in network (volume lost/network volume size)
  mutate(sum_fascicle_names_NOT_top_25_vol_x_top_25_prop = 
           rowSums(across(all_of(fascicle_names_NOT_top_25_vol_x_top_25_prop_VOL_suffix)))) %>%
  mutate(proportion_fascicle_vol_lost_NOT_top_25_vol_x_top_25_prop = sum_fascicle_names_NOT_top_25_vol_x_top_25_prop/anxiety_NOT_top_25_vol_x_top_25_prop_vol) %>%
  
   ##mean_uncinate)
  mutate(mean_UF_vol = (UF_L_vol + UF_R_vol)/2) %>%
  mutate(mean_UF_prop = (UF_L_prop + UF_R_prop)/2) %>%
           
  ungroup()   

#neurosynth_anxiety_network_fascicle_overlap
```

## Anxiety within/outside network interaction
```{r anxiety_net_intx}

## demographics


### BEST SPLIT IS STRATIFYING ON ANXIETY MEDS!!!! Better than on variable that includes anxietyGroupVar(meds + anxiety diagnoses), or anxiety diagnosis alone
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles)
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles[df_demo_and_fascicles$anxietyGroupVar != 0,])
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles[df_demo_and_fascicles$Has.Anxietydx.AND.AntianxietymedGroupVar != 0,])



#clean up data frame
df_empi_dx_network_proportions <- df_demo_and_fascicles %>%
  filter(anxietyGroupVar != 0) %>% #lose 93, n now 719
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = ifelse(anxietyGroupVar==1, "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  mutate(Has.anxietydx = as.factor(Has.anxietydx)) %>%
  mutate(Anxiolytics_status = ifelse(On.Anxiolytics_no_beta_blocker==1, "On.Anxiolytics", "Off.Anxiolytics")) %>%
  mutate(Anxiolytics_status = as.factor(Anxiolytics_status)) %>%
  mutate(Benzo_status = ifelse(On.Benzos==1, "On.Benzos", "Off.Benzos")) %>%
  mutate(Benzo_status = as.factor(Benzo_status)) %>%
  mutate(Anxiety_network = proportion_volume_lost_anxiety_net_by_network_size_sum_top_25) %>%
  mutate(Nonanxiety_network = proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75) %>%
  dplyr::select(subject, osex, Diagnosis, Anxiety_network, Nonanxiety_network, Anxiolytics_status, Has.anxietydx, Benzo_status, PAT_AGE_AT_EXAM) %>% 
  gather(Network, proportion_affected, -subject, -Diagnosis, -PAT_AGE_AT_EXAM, -osex, -Anxiolytics_status, -Has.anxietydx, -Benzo_status) %>% #this is like a melt. Keeps empi and depGroupVar out of the melt
  mutate(Network = as.factor(Network)) %>%
  ungroup()
 
#simple t test, disease within versus outside anxiety network; mean within anxiety net: 0.5426694 affected, mean outside anxiety network = 0.3062429, T=57.44, p<2.2*10^-16, 95% CI 0.22-0.24
#MS+Anxiety, MS-Anxiety, meds + anxiety dx, true normal = 0.3850697; MS+ anxiety: ; MS-anxiety: 0.3672053
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"])

#Anxiety dx vs no anxiety dx
#anxiety dx: 0.3785979; no anxiety dx: 0.3723245
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Has.anxietydx==1])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Has.anxietydx==0])

#On.Anxiolytics vs Off.Anxiolytics
#on anxiolytics: 0.415625; off anxiolytics:0.3664898
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Anxiolytics_status=="On.Anxiolytics"])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Anxiolytics_status=="Off.Anxiolytics"])

#On.Benzos vs Off.Benzos
#on benzos: 0.4022933; off benzos:0.372135
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Benzo_status=="On.Benzos"])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Benzo_status=="Off.Benzos"])

#Has.Anxietydx.Or.Antianxietymed
#on benzos: 0.4022933; off benzos:0.372135
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Has.Anxietydx.Or.Antianxietymed=="On.Benzos"])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Has.Anxietydx.Or.Antianxietymed=="Off.Benzos"])

#histos
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], main = "Anxiety Network Injury", xlab = "Proportion Affected")
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], main = "Nonanxiety Network Injury", xlab = "Proportion Affected")

## Means of separate groups: 

#t test, t = 63.621, df = 718, p-value < 2.2e-16; 95 percent confidence interval:0.2349467 0.2499088, mean diff: 0.2424277 
within_vs_outside_anxiety_net_t <- t.test(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], paired = T)
summary(within_vs_outside_anxiety_net_t)

 #simple lmer, confirms T; -63.62   <2e-16 ***
disease_within_vs_outside_anxiety_net_lmer <- lmer(proportion_affected ~ Network + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_lmer)

 #Net by sex, confirms T; -63.62   <2e-16, but no sex differences (p=0.179)
disease_within_vs_outside_anxiety_net_sex_lmer <- lmer(proportion_affected ~ Network*osex + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_sex_lmer)

 #simple lmer, confirms network: -63.621  < 2e-16 , Pat age: 6.338 4.12e-10
disease_within_vs_outside_anxiety_net_age_lmer <- lmer(proportion_affected ~ Network + PAT_AGE_AT_EXAM + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_age_lmer)

#Age * network interaction, don't know if this is valid at all. outside > w/in net: -12.718  < 2e-16 ***; pat age = 6.837  1.6e-11 ***, NetworkNonanxiety_network:PAT_AGE_AT_EXAM -2.852  0.00447 
disease_within_vs_outside_anxiety_net_age_intx_lmer <- lmer(proportion_affected ~ Network*PAT_AGE_AT_EXAM + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_age_intx_lmer)

#diagnosis: NS
diagnosis_by_network_interaction_lmer <- lmer(proportion_affected ~ Diagnosis*Network + (1|subject), data = df_empi_dx_network_proportions)
summary(diagnosis_by_network_interaction_lmer)

#Diagnosis: NS
confint(diagnosis_by_network_interaction_lmer)

## Anxiety network x anxiolytics status
#Network (nonanxiety <anxiety network) : T = -58.141   <2e-16 ***; Anxiolytic status: On.anxiolytics>off.anxiolytics; T= 2.473   0.0136 *  
#Mean prop affected: on anxiolytics: 0.415625;  off anxioloytics: 0.3664898

disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer <- lmer(proportion_affected ~ Network*Anxiolytics_status + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer)
confint(disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer)

## Anxiety network x benzo status
#Network (nonanxiety <anxiety network) : T = -54.535   <2e-16***; Anxiety status: T = 0.462    P = 0.645

disease_within_vs_outside_anxiety_net_by_benzo_lmer <- lmer(proportion_affected ~ Network*Benzo_status + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_benzo_lmer)
confint(disease_within_vs_outside_anxiety_net_by_benzo_lmer)

## Anxiety network x anxiety diagnosis
#Network (nonanxiety <anxiety network) : T = -54.535   <2e-16***; Anxiety status: T = 0.462    P = 0.645

disease_within_vs_outside_anxiety_net_by_anxietydx_lmer <- lmer(proportion_affected ~ Network*Has.anxietydx + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_anxietydx_lmer)
confint(disease_within_vs_outside_anxiety_net_by_anxietydx_lmer)
```


#Anxiety network interactions and uncinate alone
```{r anxiety_net_intx}

## demographics

make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles)
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles[df_demo_and_fascicles$Has.Anxietydx.AND.AntianxietymedGroupVar != 0,])

#clean up data frame
cleaned_df <- df_demo_and_fascicles %>%
  filter(Has.Anxietydx.AND.AntianxietymedGroupVar != 0) %>% #lose 93, n now 719
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = ifelse(Has.Anxietydx.AND.AntianxietymedGroupVar==1, "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  mutate(Anxiety_network = proportion_volume_lost_anxiety_net_by_network_size_sum_top_25) %>%
  mutate(Nonanxiety_network = proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75) %>%
  mutate(mean_uncinate_injury = (UF_L_prop + UF_R_prop)/2) %>%
  mutate(mean_uncinate_and_fornix_injury = (UF_L_prop + UF_R_prop + F_R_prop + F_L_prop)/2) %>%
  ungroup()

df_empi_dx_network_proportions <- cleaned_df %>%
  dplyr::select(subject, osex, Diagnosis, Anxiety_network, Nonanxiety_network, PAT_AGE_AT_EXAM) %>% 
  gather(Network, proportion_affected, -subject, -Diagnosis, -PAT_AGE_AT_EXAM, -osex) %>% #this is like a melt. Keeps empi and depGroupVar out of the melt
  mutate(Network = as.factor(Network)) %>%
  ungroup()
 

#histos
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], main = "Anxiety Network Injury", xlab = "Proportion Affected")
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], main = "Nonanxiety Network Injury", xlab = "Proportion Affected")
hist(cleaned_df$mean_uncinate_injury[cleaned_df$Diagnosis == "MS+Anxiety"], main = "Uncinate Injury in Anxious Patients", xlab = "Proportion Affected")
hist(cleaned_df$mean_uncinate_injury[cleaned_df$Diagnosis == "MS-Anxiety"], main = "Uncinate Injury in Healthyish Patients", xlab = "Proportion Affected")


## Means of separate groups: 


#t test, 
within_vs_outside_anxiety_net_t <- t.test(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], paired = T)
within_vs_outside_anxiety_net_t


#diagnosis: 
diagnosis_by_network_interaction_lmer <- lmer(proportion_affected ~ Diagnosis*Network + (1|subject), data = df_empi_dx_network_proportions)
summary(diagnosis_by_network_interaction_lmer)
confint(diagnosis_by_network_interaction_lmer)

#Net by sex, confirms T; -63.62   <2e-16, but no sex differences (p=0.179)
disease_within_vs_outside_anxiety_net_sex_lmer <- lmer(proportion_affected ~ Network*osex + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_sex_lmer)

#t test uncinate alone
mean_uncinate_by_dx_t <- t.test(cleaned_df$mean_uncinate_injury[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"], cleaned_df$mean_uncinate_injury[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"], paired = F)
mean_uncinate_by_dx_t

#diagnosisxmean_uncinate: 
diagnosis_by_network_interaction_lmer <- lm(mean_uncinate_injury ~ Diagnosis, data = cleaned_df)
summary(diagnosis_by_network_interaction_lmer)
confint(diagnosis_by_network_interaction_lmer)

#diagnosisxmean_uncinate+fornix: 
diagnosis_by_network_interaction_lmer <- lm(mean_uncinate_and_fornix_injury ~ Diagnosis, data = cleaned_df)
summary(diagnosis_by_network_interaction_lmer)
confint(diagnosis_by_network_interaction_lmer)

#### if I decide later I want to look at L and right uncinate alone

#t test uncinate alone, Left,
l_uncinate_by_dx_t <- t.test(cleaned_df$UF_L_prop[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"], cleaned_df$UF_L_prop[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"], paired = F)
l_uncinate_by_dx_t

#t test uncinate alone, right, remember everybody is double counted!!!! so this needs to be fixed.
r_uncinate_by_dx_t <- t.test(cleaned_df$UF_R_prop[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"], cleaned_df$UF_R_prop[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"], paired = F)
r_uncinate_by_dx_t


```

## Anxiety burden severity ranking

I am wondering here if, as my brain wants to think, that things in the chart reflect severity of anxiety. For example, I'd expect people with dep and anxiety comorbidity and on meds would be the sickest, followed by anxiety + on meds, then on meds, then anxiety dx, then healthyish. I am going to do a t-test comparing proportion of disease over whole brain, over anxiety net, and over uncinate in each of those groups as compared to the healthy group, and rank the T to see if that pattern bears out. And if it does, do some sort of regression.
```{r anxiety_burden_severity_ranking }
#variables_to_evaluate <- c("Has.Anxietydx.AND.AntianxietymedGroupVar")
df_disease_burden_unc_and_anx_net <- df_demo_and_fascicles %>%
  filter(oAnxiety.And.Dep.And.AnxietyMedsGroupVar != "unclassified") %>%
  dplyr::select(proportion_volume_lost_per_total_network_size_sum, proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75, UF_L_prop, UF_R_prop, oAnxiety.And.Dep.And.AnxietyMedsGroupVar, osex) 

tibble_n <- df_disease_burden_unc_and_anx_net %>% 
  group_by(oAnxiety.And.Dep.And.AnxietyMedsGroupVar) %>% 
  summarise(n())

tibble_overall_disease <- 
  df_disease_burden_unc_and_anx_net %>% 
  group_by(oAnxiety.And.Dep.And.AnxietyMedsGroupVar) %>%
  summarize(mean_size = mean(proportion_volume_lost_per_total_network_size_sum))

tibble_overall_summaries <- 
  df_disease_burden_unc_and_anx_net %>% 
  group_by(oAnxiety.And.Dep.And.AnxietyMedsGroupVar) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
tibble_overall_summaries

tibble_overall_summaries_by_sex <- 
  df_disease_burden_unc_and_anx_net %>% 
  group_by(oAnxiety.And.Dep.And.AnxietyMedsGroupVar, osex) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_by_sex          

  tibble_overall_summaries_females <- 
  df_disease_burden_unc_and_anx_net %>% 
  filter(osex == "Female") %>%
  group_by(oAnxiety.And.Dep.And.AnxietyMedsGroupVar) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_females  
  
    tibble_overall_summaries_males <- 
  df_disease_burden_unc_and_anx_net %>% 
  filter(osex == "Male") %>%
  group_by(oAnxiety.And.Dep.And.AnxietyMedsGroupVar) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_males  
  
  ### analyses
    
```

#### plots
```{r}
  #proportion injured over whole brain
prop_injured_by_anxiety_burden_plot <-  ggplot(df_disease_burden_unc_and_anx_net, aes(x=oAnxiety.And.Dep.And.AnxietyMedsGroupVar, y=proportion_volume_lost_per_total_network_size_sum, fill=oAnxiety.And.Dep.And.AnxietyMedsGroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_by_anxiety_burden_plot

  #proportion injured over anxiety net
prop_injured_anxiety_net_by_anxiety_burden_plot <-  ggplot(df_disease_burden_unc_and_anx_net, aes(x=oAnxiety.And.Dep.And.AnxietyMedsGroupVar, y=proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, fill=oAnxiety.And.Dep.And.AnxietyMedsGroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_anxiety_net_by_anxiety_burden_plot

  #proportion injured over nonanxiety net
prop_injured_nonanxiety_net_by_anxiety_burden_plot <-  ggplot(df_disease_burden_unc_and_anx_net, aes(x=oAnxiety.And.Dep.And.AnxietyMedsGroupVar, y=proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75, fill=oAnxiety.And.Dep.And.AnxietyMedsGroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_nonanxiety_net_by_anxiety_burden_plot

  #proportion injured over R Uncinate prop
prop_injured_R_uncinate_by_anxiety_burden_plot <-  ggplot(df_disease_burden_unc_and_anx_net, aes(x=oAnxiety.And.Dep.And.AnxietyMedsGroupVar, y=UF_R_prop, fill=oAnxiety.And.Dep.And.AnxietyMedsGroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_R_uncinate_by_anxiety_burden_plot

  #proportion injured over L Uncinate prop
prop_injured_L_uncinate_by_anxiety_burden_plot <-  ggplot(df_disease_burden_unc_and_anx_net, aes(x=oAnxiety.And.Dep.And.AnxietyMedsGroupVar, y=UF_L_prop, fill=oAnxiety.And.Dep.And.AnxietyMedsGroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_L_uncinate_by_anxiety_burden_plot

prop_injured_by_anxiety_burden_and_sex_plot <- ggboxplot(df_disease_burden_unc_and_anx_net, x = "oAnxiety.And.Dep.And.AnxietyMedsGroupVar", y = "proportion_volume_lost_per_total_network_size_sum", color = "osex",
          palette = c("#00AFBB", "#E7B800")) +
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_by_anxiety_burden_and_sex_plot

```


#Anxiety network interactions and uncinate alone, TRUE HEALTHY
```{r anxiety_net_intx}

## demographics

make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles)
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles[df_demo_and_fascicles$oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar != "unclassified",])

#clean up data frame
cleaned_df <- df_demo_and_fascicles %>%
  filter(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar != "unclassified") %>% #lose 93, n now 719
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = ifelse(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar=="true_healthy", "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  mutate(Anxiety_network = proportion_volume_lost_anxiety_net_by_network_size_sum_top_25) %>%
  mutate(Nonanxiety_network = proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75) %>%
  mutate(mean_uncinate_injury = (UF_L_prop + UF_R_prop)/2) %>%
  mutate(mean_uncinate_and_fornix_injury = (UF_L_prop + UF_R_prop + F_R_prop + F_L_prop)/2) %>%
  ungroup()

df_empi_dx_network_proportions <- cleaned_df %>%
  dplyr::select(subject, osex, Diagnosis, Anxiety_network, Nonanxiety_network, PAT_AGE_AT_EXAM) %>% 
  gather(Network, proportion_affected, -subject, -Diagnosis, -PAT_AGE_AT_EXAM, -osex) %>% #this is like a melt. Keeps empi and depGroupVar out of the melt
  mutate(Network = as.factor(Network)) %>%
  ungroup()
 

#histos
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], main = "Anxiety Network Injury", xlab = "Proportion Affected")
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], main = "Nonanxiety Network Injury", xlab = "Proportion Affected")
hist(cleaned_df$mean_uncinate_injury[cleaned_df$Diagnosis == "MS+Anxiety"], main = "Uncinate Injury in Anxious Patients", xlab = "Proportion Affected")
hist(cleaned_df$mean_uncinate_injury[cleaned_df$Diagnosis == "MS-Anxiety"], main = "Uncinate Injury in Healthyish Patients", xlab = "Proportion Affected")


## Means of separate groups: 


#t test, 
within_vs_outside_anxiety_net_t <- t.test(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], paired = T)
within_vs_outside_anxiety_net_t


#diagnosis: 
diagnosis_by_network_interaction_lmer <- lmer(proportion_affected ~ Diagnosis*Network + (1|subject), data = df_empi_dx_network_proportions)
summary(diagnosis_by_network_interaction_lmer)
confint(diagnosis_by_network_interaction_lmer)

#Net by sex, confirms T; -63.62   <2e-16, but no sex differences (p=0.179)
disease_within_vs_outside_anxiety_net_sex_lmer <- lmer(proportion_affected ~ Network*osex + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_sex_lmer)

#t test uncinate alone
mean_uncinate_by_dx_t <- t.test(cleaned_df$mean_uncinate_injury[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"], cleaned_df$mean_uncinate_injury[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"], paired = F)
mean_uncinate_by_dx_t

#diagnosisxmean_uncinate: 
diagnosis_by_network_interaction_lmer <- lm(mean_uncinate_injury ~ Diagnosis, data = cleaned_df)
summary(diagnosis_by_network_interaction_lmer)
confint(diagnosis_by_network_interaction_lmer)

#diagnosisxmean_uncinate+fornix: 
diagnosis_by_network_interaction_lmer <- lm(mean_uncinate_and_fornix_injury ~ Diagnosis, data = cleaned_df)
summary(diagnosis_by_network_interaction_lmer)
confint(diagnosis_by_network_interaction_lmer)

#### if I decide later I want to look at L and right uncinate alone

#t test uncinate alone, Left,
l_uncinate_by_dx_t <- t.test(cleaned_df$UF_L_prop[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"], cleaned_df$UF_L_prop[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"], paired = F)
l_uncinate_by_dx_t

#t test uncinate alone, right, remember everybody is double counted!!!! so this needs to be fixed.
r_uncinate_by_dx_t <- t.test(cleaned_df$UF_R_prop[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"], cleaned_df$UF_R_prop[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"], paired = F)
r_uncinate_by_dx_t


```

## Anxiety burden severity ranking true healthy

I am wondering here if, as my brain wants to think, that things in the chart reflect severity of anxiety. For example, I'd expect people with dep and anxiety comorbidity and on meds would be the sickest, followed by anxiety + on meds, then on meds, then anxiety dx, then healthyish. I am going to do a t-test comparing proportion of disease over whole brain, over anxiety net, and over uncinate in each of those groups as compared to the healthy group, and rank the T to see if that pattern bears out. And if it does, do some sort of regression.
```{r anxiety_burden_severity_ranking }
#variables_to_evaluate <- c("Has.Anxietydx.AND.AntianxietymedGroupVar")
df_disease_burden_unc_and_anx_net_true_healthy <- df_demo_and_fascicles %>%
  filter(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar != "unclassified") %>%
  dplyr::select(proportion_volume_lost_per_total_network_size_sum, proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75, UF_L_prop, UF_R_prop, oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar, osex) 

tibble_n <- df_disease_burden_unc_and_anx_net_true_healthy %>% 
  group_by(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar) %>% 
  summarise(n())

tibble_overall_disease <- 
  df_disease_burden_unc_and_anx_net_true_healthy %>% 
  group_by(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar) %>%
  summarize(mean_size = mean(proportion_volume_lost_per_total_network_size_sum))

tibble_overall_summaries <- 
  df_disease_burden_unc_and_anx_net_true_healthy %>% 
  group_by(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
tibble_overall_summaries

tibble_overall_summaries_by_sex <- 
  df_disease_burden_unc_and_anx_net_true_healthy %>% 
  group_by(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar, osex) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_by_sex          

  tibble_overall_summaries_females <- 
  df_disease_burden_unc_and_anx_net_true_healthy %>% 
  filter(osex == "Female") %>%
  group_by(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_females  
  
    tibble_overall_summaries_males <- 
  df_disease_burden_unc_and_anx_net_true_healthy %>% 
  filter(osex == "Male") %>%
  group_by(oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_males  
  
  ### analyses
  
```

#### plots
```{r}
  #proportion injured over whole brain
prop_injured_by_anxiety_burden_true_healty_plot <-  ggplot(df_disease_burden_unc_and_anx_net_true_healthy, aes(x=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar, y=proportion_volume_lost_per_total_network_size_sum, fill=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_by_anxiety_burden_true_healty_plot

  #proportion injured over anxiety net
prop_injured_anxiety_net_by_anxiety_burden_true_healty_plot <-  ggplot(df_disease_burden_unc_and_anx_net_true_healthy, aes(x=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar, y=proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, fill=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_anxiety_net_by_anxiety_burden_true_healty_plot

  #proportion injured over nonanxiety net
prop_injured_nonanxiety_net_by_anxiety_burden_true_healty_plot <-  ggplot(df_disease_burden_unc_and_anx_net_true_healthy, aes(x=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar, y=proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75, fill=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_nonanxiety_net_by_anxiety_burden_true_healty_plot

  #proportion injured over R Uncinate prop
prop_injured_R_uncinate_by_anxiety_burden_true_healty_plot <-  ggplot(df_disease_burden_unc_and_anx_net_true_healthy, aes(x=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar, y=UF_R_prop, fill=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_R_uncinate_by_anxiety_burden_true_healty_plot

  #proportion injured over L Uncinate prop
prop_injured_L_uncinate_by_anxiety_burden_true_healty_plot <-  ggplot(df_disease_burden_unc_and_anx_net_true_healthy, aes(x=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar, y=UF_L_prop, fill=oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_L_uncinate_by_anxiety_burden_true_healty_plot

prop_injured_by_anxiety_burden_and_sex_true_healty_plot <- ggboxplot(df_disease_burden_unc_and_anx_net_true_healthy, x = "oAnxiety.And.Dep.And.AnxietyMeds.TrueHealthy.GroupVar", y = "proportion_volume_lost_per_total_network_size_sum", color = "osex",
          palette = c("#00AFBB", "#E7B800")) +
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_by_anxiety_burden_and_sex_true_healty_plot

```



##Collapse anxiety dx and antianxiety meds with those plus depression
```{r group_anxietydx_meds_and_dep_comorbidity}


#this collapses anxiety group + meds with those with anxiety group + meds + with/without depression

df_disease_burden_unc_and_anx_net_collapsed_variables <- df_demo_and_fascicles %>%
  filter(oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  dplyr::select(proportion_volume_lost_per_total_network_size_sum, proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75, UF_L_prop, UF_R_prop, oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, osex) 
 

 tibble_overall_summaries <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  group_by(oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
tibble_overall_summaries 


tibble_overall_summaries_by_sex <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  group_by(oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, osex) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_by_sex          

  tibble_overall_summaries_females <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  filter(osex == "Female") %>%
  group_by(oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_females  
  
    tibble_overall_summaries_males <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  filter(osex == "Male") %>%
  group_by(oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_males  
 
  #mean disease
  anxietyGrouping_mean_disease_lm <- lm(proportion_volume_lost_per_total_network_size_sum ~ oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, data=df_demo_and_fascicles)
  summary(anxietyGrouping_mean_disease_lm)
  
  anxietyGrouping_by_sex_mean_disease_lm <- lm(proportion_volume_lost_per_total_network_size_sum ~ oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed*osex, data=df_demo_and_fascicles)
  summary(anxietyGrouping_by_sex_mean_disease_lm)
  
  #anxiety network
  anxietyGrouping_anxiety_net_lm <- lm(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, data=df_demo_and_fascicles)
  summary(anxietyGrouping_anxiety_net_lm)
  
  anxietyGrouping_by_sex_anxiety_net_lm <- lm(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed*osex, data=df_demo_and_fascicles)
  summary(anxietyGrouping_by_sex_anxiety_net_lm)
  
  #UF R
  anxietyGrouping_UF_R_lm <- lm(UF_R_vol ~ oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, data=df_demo_and_fascicles)
  summary(anxietyGrouping_UF_R_lm)
  
  anxietyGrouping_UF_R_by_sex_lm <- lm(UF_R_vol ~ oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed*osex, data=df_demo_and_fascicles)
  summary(anxietyGrouping_UF_R_by_sex_lm)
  
  #UF L
  anxietyGrouping_UF_L_lm <- lm(UF_L_vol ~ oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, data=df_demo_and_fascicles)
  summary(anxietyGrouping_UF_L_lm)
  
  anxietyGrouping_UF_L_by_sex_lm <- lm(UF_L_vol ~ oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed*osex, data=df_demo_and_fascicles)
  summary(anxietyGrouping_UF_L_by_sex_lm)
  
  #burden of anxiety by network
  #clean up data frame
  df_empi_dx_network_proportions <- df_demo_and_fascicles %>%
  #filter(oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed == c("true_healthy", "Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep")) %>% 
  #filter(oAnxietydx.Meds.Inc.Dep.Collapsed == c("healthy_ish", "Has.anxietydx")) %>%  #-> doesn't work
 # filter(oAnxietydx.Meds.Inc.Dep.Collapsed == c("healthy_ish", "On.Anxiolytics")) %>% #-> doesn't work
  mutate(subject = as.factor(EMPI)) %>%
#  mutate(Diagnosis = oAnxietydx.Meds.Inc.Dep.Collapsed) %>%
  mutate(Diagnosis = ifelse(oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed=="true_healthy", "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  #mutate(Has.anxietydx = as.factor(Has.anxietydx)) %>%
  #mutate(Anxiolytics_status = ifelse(On.Anxiolytics_no_beta_blocker==1, "On.Anxiolytics", "Off.Anxiolytics")) %>%
  #mutate(Anxiolytics_status = as.factor(Anxiolytics_status)) %>%
  ##mutate(Benzo_status = ifelse(On.Benzos==1, "On.Benzos", "Off.Benzos")) %>%
  #mutate(Benzo_status = as.factor(Benzo_status)) %>%
  mutate(Anxiety_network = proportion_volume_lost_anxiety_net_by_network_size_sum_top_25) %>%
  mutate(Nonanxiety_network = proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75) %>%
  dplyr::select(subject, osex, Diagnosis, Anxiety_network, Nonanxiety_network, PAT_AGE_AT_EXAM, UF_R_vol, UF_L_vol) %>% 
  gather(Network, proportion_affected, -subject, -Diagnosis, -PAT_AGE_AT_EXAM, -osex, -UF_R_vol, -UF_L_vol) %>% #this is like a melt. Keeps empi and depGroupVar out of the melt
  mutate(Network = as.factor(Network)) %>%
  ungroup()
 

## Means of separate groups: 

#t test, t, t = 37.378, df = 271, p-value < 2.2e-16, anxiety net: 0.4974984; nonanxiety net: 0.256347
within_vs_outside_anxiety_net_t <- t.test(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], paired = T)
summary(within_vs_outside_anxiety_net_t)

#t test, between diagnoses, NS, mean MS+ANXIETY = .40, MS-Anxiety = 0.37
between_dx_t <- t.test(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"], df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"])
summary(between_dx_t)

#means

#mean = 0.5381082
mean_anxiety_dx_anx_net <- mean(df_empi_dx_network_proportions$proportion_affected[which(df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety" & df_empi_dx_network_proportions$Network == "Anxiety_network")])
mean_anxiety_dx_anx_net

#mean = 0.2681277
mean_anxiety_dx_nonanx_net <- mean(df_empi_dx_network_proportions$proportion_affected[which(df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety" & df_empi_dx_network_proportions$Network == "Nonanxiety_network")])
mean_anxiety_dx_nonanx_net

#mean = 0.4762486
mean_nonanxiety_dx_anx_net <- mean(df_empi_dx_network_proportions$proportion_affected[which(df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety" & df_empi_dx_network_proportions$Network == "Anxiety_network")])
mean_nonanxiety_dx_anx_net

#mean = 0.2444919
mean_nonanxiety_dx_nonanx_net <- mean(df_empi_dx_network_proportions$proportion_affected[which(df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety" & df_empi_dx_network_proportions$Network == "Nonanxiety_network")])
mean_nonanxiety_dx_nonanx_net

 #simple lmer, NetworkNonanxiety_network   -0.23176    0.01462 85.00000 -15.855   <2e-16 ***; NetworkNonanxiety_network:DiagnosisMS+Anxiety -0.03822    0.02241 85.00000  -1.705   0.0918 .
disease_within_vs_outside_anxiety_net_by_dx_groups_lmer <- lmer(proportion_affected ~ Network*Diagnosis + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_dx_groups_lmer)

#Network confit:NetworkNonanxiety_network -0.2496593 -0.23419230
confint(disease_within_vs_outside_anxiety_net_by_dx_groups_lmer)

#do anova instead

disease_within_vs_outside_anxiety_net_by_dx_groups_anova <- aov(proportion_affected ~ Network+Diagnosis + Network:Diagnosis, data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_dx_groups_anova)

#do lm UF*Diagnosis
 #UF_R_vol -> NS
disease_UF_R_vol_lm <- lm(UF_R_vol ~ Diagnosis, data = df_empi_dx_network_proportions)
summary(disease_UF_R_vol_lm)

 #UF_L_vol -> NS
disease_UF_L_vol_lm <- lm(UF_L_vol ~ Diagnosis, data = df_empi_dx_network_proportions)
summary(disease_UF_L_vol_lm)


```

###plots
```{r}
prop_injured_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x= oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed , y=proportion_volume_lost_per_total_network_size_sum, fill= oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed )) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_by_anxiety_burden_collapsed_vars_plot

  #proportion injured over anxiety net
prop_injured_anxiety_net_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x=oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, y=proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, fill=oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_anxiety_net_by_anxiety_burden_collapsed_vars_plot

  #proportion injured over nonanxiety net
prop_injured_nonanxiety_net_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x=oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, y=proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75, fill=oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_nonanxiety_net_by_anxiety_burden_collapsed_vars_plot

  #proportion injured over R Uncinate prop
prop_injured_R_uncinate_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x=oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, y=UF_R_prop, fill=oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_R_uncinate_by_anxiety_burden_collapsed_vars_plot

  #proportion injured over L Uncinate prop
prop_injured_L_uncinate_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x=oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed, y=UF_L_prop, fill=oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_L_uncinate_by_anxiety_burden_collapsed_vars_plot

prop_injured_by_anxiety_burden_and_sex_true_healty_collapsed_plot <- ggboxplot(df_disease_burden_unc_and_anx_net_collapsed_variables, x = "oAnxietydx.Meds.And.Dep.True.Healthy.Collapsed", y = "proportion_volume_lost_per_total_network_size_sum", color = "osex",
          palette = c("#00AFBB", "#E7B800")) +
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_by_anxiety_burden_and_sex_true_healty_collapsed_plot
```






#COLLAPSE anxiety dx and antianxiety meds with those plus depression, and anxiety dx OR on anxiety meds into 1 group -->> THIS IS THE MONEY
### Overlap with depression group
```{r overlap_with_dep_group}
#### 53.4% overlap total

#read csv of empis from depression paper
depression_empis <- read.table(file="/Users/eballer/BBL/msanxiety/data/empis_of_people_in_BP_depression_paper.csv")
names(depression_empis) <- "EMPI"

#get final anxiety dataset and make column if the empi is in the prev list
df_disease_burden_unc_and_anx_net_collapsed_variables <- df_demo_and_fascicles %>%
  mutate(EMPI = as.numeric(EMPI)) %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  mutate(EMPI_in_dep_group = EMPI %in% depression_empis$EMPI)

#"Percent overlap 53.4%"
print(paste0("Percent overlap ", round(sum(df_disease_burden_unc_and_anx_net_collapsed_variables$EMPI_in_dep_group)/length(df_disease_burden_unc_and_anx_net_collapsed_variables$EMPI), 3) * 100, "%"))

 tibble_overall_counts <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  group_by(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  summarize(n(),
            num_in_dep_group = sum(EMPI_in_dep_group),
            percent_overlap = num_in_dep_group/n())
 tibble_overall_counts


```

### Overall Disease by Anxiety Dose *acnp
```{r group_anxietydx_meds_and_dep_comorbidity}
#this collapses anxiety group + meds with those with anxiety group + meds + with/without depression

#demo
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles[df_demo_and_fascicles$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified",])

make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles[((df_demo_and_fascicles$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") & (df_demo_and_fascicles$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "Has.Anxietydx.OR.Antianxiety.Meds")),])


df_disease_burden_unc_and_anx_net_collapsed_variables <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>% 
  dplyr::select(proportion_volume_lost_per_total_network_size_sum, proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75, UF_L_prop, UF_R_prop, oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed, osex, anxiety_dose) 
 

 tibble_overall_summaries <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  group_by(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
tibble_overall_summaries 


tibble_overall_summaries_by_sex <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  group_by(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed, osex) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_by_sex          

  tibble_overall_summaries_females <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  filter(osex == "Female") %>%
  group_by(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_females  
  
    tibble_overall_summaries_males <- df_disease_burden_unc_and_anx_net_collapsed_variables %>% 
  filter(osex == "Male") %>%
  group_by(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  summarize(n(),
            mean_disease_burden = mean(proportion_volume_lost_per_total_network_size_sum),
            mean_disease_burden_anxiety_net = mean(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25),
            mean_disease_burden_nonanxiety_net = mean(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75),
            mean_UF_L = mean(UF_L_prop),
            mean_UF_R = mean(UF_R_prop))
  tibble_overall_summaries_males  
 
  #mean disease
  
  df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>% filter (anxiety_dose != 3) #3 is unclassified, 0 is no anxiety, 1 is diagnosis or on meds, 2 is diagnosis AND on meds
  
  #mean disease by anxiety dose: anxiety_dose    0.0347504  0.0149813   2.320  0.02091 *  
  anxietyGrouping_mean_disease_lm <- lm(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_mean_disease_lm)
  
  ### gam instead, anxiety_dose  0.03606    0.01493   2.416   0.0162 *
    anxietyGrouping_mean_disease_gam <- gam(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_mean_disease_gam)
  
  #mean disease with sex in model : anxiety_dose         anxiety_dose     0.0356677  0.0150093   2.376  0.01800 *  
  anxietyGrouping_by_sex_mean_disease_lm <- lm(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_by_sex_mean_disease_lm)
  
  #gam: anxiety_dose  0.03692    0.01496   2.468    0.014 *  
      anxietyGrouping_by_sex_mean_disease_gam <- gam(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose + osex+ s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
      summary(anxietyGrouping_by_sex_mean_disease_gam)
```

### Anxiety network by anxiety dose
```{r}

#define group
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter (anxiety_dose != 3)
 
  #anxiety network
  
  ###  anxiety_dose    0.036474   0.017586   2.074 0.038768 *  ; PAT_AGE_AT_EXAM 0.004132   0.001058   3.905 0.000112 ***
  anxietyGrouping_anxiety_net_lm <- lm(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_anxiety_net_lm)
  
  #gam, anxiety_dose  0.03735    0.01760   2.122   0.0345 * 
   anxietyGrouping_anxiety_net_gam<- gam(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_anxiety_net_gam)
  
  #volume lost in anxiety net by anxiety dose*sex: anxiety_dose         0.053407   0.021365   2.500   0.0129 *  , no intx
  anxietyGrouping_by_sex_anxiety_net_lm <- lm(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose*osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_by_sex_anxiety_net_lm)
  
  #gam, anxiety_dose         0.05395    0.02133   2.529   0.0119 *  
  anxietyGrouping_by_sex_anxiety_net_gam <- gam(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose*osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_by_sex_anxiety_net_gam)
  
  #volume lost in anxiety net by anxiety dose + sex + PAT_AGE_AT_EXAM: anxiety_dose     0.037282   0.017629   2.115   0.0351 *
  anxietyGrouping_cov_sex_anxiety_net_lm <- lm(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_cov_sex_anxiety_net_lm)
  
  #gam, anxiety_dose  0.03810    0.01765   2.159   0.0315 * 
   anxietyGrouping_cov_sex_anxiety_net_gam <- gam(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_cov_sex_anxiety_net_gam)
  
  
```

### NonAnxiety network by anxiety dose
```{r}

#define group
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter (anxiety_dose != 3)
 
  #anxiety network
  
  ###  anxiety_dose: anxiety_dose    0.0334038  0.0135143   2.472   0.0139 * 
  anxietyGrouping_nonanxiety_net_lm <- lm(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_nonanxiety_net_lm)
  
  #gam, anxiety_dose  , anxiety_dose  0.03505    0.01340   2.616  0.00927 ** 
   anxietyGrouping_nonanxiety_net_gam<- gam(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_nonanxiety_net_gam)
  
  #volume lost in anxiety net by anxiety dose*sex: anxiety_dose         0.0459425  0.0164036   2.801  0.00537 ** 
  anxietyGrouping_by_sex_nonanxiety_net_lm <- lm(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose*osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_by_sex_nonanxiety_net_lm)
  
  #gam, anxiety_dose, anxiety_dose         0.047100   0.016230   2.902  0.00393 **          
  anxietyGrouping_by_sex_nonanxiety_net_gam <- gam(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose*osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_by_sex_nonanxiety_net_gam)
  
  #volume lost in anxiety net by anxiety dose + sex + PAT_AGE_AT_EXAM: anxiety_dose     0.0344065  0.0135309   2.543   0.0114 *  
  anxietyGrouping_cov_sex_nonanxiety_net_lm <- lm(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_cov_sex_nonanxiety_net_lm)
  
  #gam, anxiety_dose - anxiety_dose  0.03600    0.01342   2.682  0.00764 ** 
   anxietyGrouping_cov_sex_nonanxiety_net_gam <- gam(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_cov_sex_nonanxiety_net_gam)
  
  
```

###Check for polynomial relationships 
```{r polynomial_relationships}
 #Not finding them w healthy, anxietydx OR meds, anxiety AND meds 

 #check for polynomial relationship
#define group
df_demo_and_fascicles_no_unclass_anxiety_dose_factor <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter (anxiety_dose != 3) %>% 
  mutate(anxiety_dose = as.factor(anxiety_dose))


contrasts(df_demo_and_fascicles_no_unclass_anxiety_dose_factor$anxiety_dose) <- contr.poly(3)

# Perform Anova across all regions, anxiety_dose      2  0.195  0.0975   2.508  0.0829 .  
anova_result_contrasts_whole_brain <- aov(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose + PAT_AGE_AT_EXAM + osex, data = df_demo_and_fascicles_no_unclass_anxiety_dose_factor)
summary(anova_result_contrasts_whole_brain)

# Perform ANOVA again with contrasts anxiety net, anxiety_dose      2  0.216  0.1079   2.012 0.135161    
anova_result_contrasts_anxiety_net <- aov(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose + PAT_AGE_AT_EXAM + osex, data = df_demo_and_fascicles_no_unclass_anxiety_dose_factor)
summary(anova_result_contrasts_anxiety_net)

# Nonanxiety Net - anxiety_dose      2  0.180  0.0898   2.842   0.0596 . 
anova_result_contrasts_nonanxiety_net <- aov(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose + PAT_AGE_AT_EXAM + osex, data = df_demo_and_fascicles_no_unclass_anxiety_dose_factor)
summary(anova_result_contrasts_nonanxiety_net)

#UF_R_vol, anxiety_dose      2 2.219e+07  11094236   1.811    0.165 

anova_result_contrasts_UF_R_net <- aov(UF_R_vol ~ anxiety_dose + PAT_AGE_AT_EXAM + osex, data = df_demo_and_fascicles_no_unclass_anxiety_dose_factor)
summary(anova_result_contrasts_UF_R_net)

#UF_L_vol, anxiety_dose      2 6.053e+06  3026730   0.988    0.373  
anova_result_contrasts_UF_L_net <- aov(UF_L_vol ~ anxiety_dose + PAT_AGE_AT_EXAM + osex, data = df_demo_and_fascicles_no_unclass_anxiety_dose_factor)
summary(anova_result_contrasts_UF_L_net)

```

### Lesion volumes 
#### Diagnosis 
  - sick > healthy in vol of lesions
```{r lesion_volumes_dx}
 df_empi_dx_network_proportions <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "Has.Anxietydx.OR.Antianxiety.Meds") %>%
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  mutate(Diagnosis = ifelse(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="true_healthy", "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  dplyr::select(subject, osex, Diagnosis, PAT_AGE_AT_EXAM, volume_of_mimosa_lesions) %>%
  ungroup()
 
##### healthy vs sick

#lm lesion volumes; DiagnosisMS+Anxiety  6310.99    2143.87   2.944 0.003694 ** 
volume_of_mimosa_lesions_lm <- lm(volume_of_mimosa_lesions ~ Diagnosis + osex + PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(volume_of_mimosa_lesions_lm)

#gam lesion volumes; DiagnosisMS+Anxiety   6973.5     2014.7   3.461 0.000681 ***
volume_of_mimosa_lesions_gam <- gam(volume_of_mimosa_lesions ~ Diagnosis + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data = df_empi_dx_network_proportions)
summary(volume_of_mimosa_lesions_gam)
```

#### Anxiety dose
  - anxiety dose correlates with disease burden (volume of lesions)
```{r lesion_volumes_anxiety_dose}
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter (anxiety_dose != 3) 

#dose; anxiety_dose     3028.07    1014.45   2.985 0.003026 ** 

  anxiety_dose_volume_of_mimosa_lesions_by_sex_lm <- lm(volume_of_mimosa_lesions ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxiety_dose_volume_of_mimosa_lesions_by_sex_lm)
  
 #bilat anxiety dose + sex + age: anxiety_dose   3304.7      985.8   3.352 0.000886 ***

  anxiety_dose_volume_of_mimosa_lesions_by_sex_gam <- gam(volume_of_mimosa_lesions ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxiety_dose_volume_of_mimosa_lesions_by_sex_gam)
  
```

### Uncinate **ACNP**

#### Demographics
```{r demo_uncinate}


###### all groups, no unclassified
make_demographics_table_ms_anxiety_simple(df_demo_and_fascicles %>% filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified"))

###### just healthy and sick
make_demographics_table_ms_anxiety_simple(df_demo_and_fascicles %>% filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "Has.Anxietydx.OR.Antianxiety.Meds"))

```
#### Uncinate by diagnosis 
```{r uncinate_by_dx}


### Results: LM Mean UF_R & L, age, sex cov, DiagnosisMS+Anxiety   621.95     276.11   2.252   0.0256 * 
#define group
  df_empi_dx_network_proportions <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "Has.Anxietydx.OR.Antianxiety.Meds") %>%
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  mutate(Diagnosis = ifelse(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="true_healthy", "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  dplyr::select(subject, osex, Diagnosis, PAT_AGE_AT_EXAM, UF_R_vol, UF_L_vol, F_R_vol, F_L_vol, mean_UF_vol) %>%
  ungroup()
 

#do lm UF*Diagnosis
 #UF_R_vol -> DiagnosisMS+Anxiety   793.14     361.94   2.191   0.0298 *   
disease_UF_R_vol_lm <- lm(UF_R_vol ~ Diagnosis + osex + PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_UF_R_vol_lm)

 #UF_L_vol ->DiagnosisMS+Anxiety   450.75     261.20   1.726   0.0862 .    
disease_UF_L_vol_lm <- lm(UF_L_vol ~ Diagnosis + osex+PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_UF_L_vol_lm)

#bilat: DiagnosisMS+Anxiety   621.95     276.11   2.252   0.0256 *  
disease_mean_UF_vol_lm <- lm(mean_UF_vol ~ Diagnosis + osex+PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_mean_UF_vol_lm)

#gam
#UF_R_vol -> DiagnosisMS+Anxiety   795.60     366.58   2.170   0.0314 *   
disease_UF_R_vol_gam <- gam(UF_R_vol ~ Diagnosis + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data = df_empi_dx_network_proportions)
summary(disease_UF_R_vol_gam)

 #UF_L_vol -> DiagnosisMS+Anxiety   420.24     262.19   1.603    0.111   
disease_UF_L_vol_gam <- gam(UF_L_vol ~ Diagnosis + osex+s(PAT_AGE_AT_EXAM, k = 4, fx = T), data = df_empi_dx_network_proportions)
summary(disease_UF_L_vol_gam)

#bilateral UF: DiagnosisMS+Anxiety   607.92     279.34   2.176   0.0309 *  
disease_mean_UF_vol_gam <- gam(mean_UF_vol ~ Diagnosis + osex+s(PAT_AGE_AT_EXAM, k = 4, fx = T), data = df_empi_dx_network_proportions)
summary(disease_mean_UF_vol_gam)

#Fornix - Right side but not left
 #F_R_vol -> DiagnosisMS+Anxiety   860.50     368.16   2.337   0.0205 * 
#disease_F_R_vol_lm <- lm(F_R_vol ~ Diagnosis + osex+ PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
#summary(disease_F_R_vol_lm)

 #F_L_vol -> DiagnosisMS+Anxiety  329.724    181.609   1.816   0.0711 . 
#disease_F_L_vol_lm <- lm(F_L_vol ~ Diagnosis + osex+ PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
#summary(disease_F_L_vol_lm)
## net by sex 
```

#### Uncinate by Anxiety Dose 
```{r uncinateByAnxietyDose}

#results: Anxiety dose related to UF_R when covarying for linear effects of age and sex, just barely
# Additionally - taking the mean of both UF and UR, LM for bilat anxiety dose + sex + age: anxiety_dose most sig P= 0.0367 *  

#define group
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter (anxiety_dose != 3) 

#lm

  #R anxiety dose + age ; anxiety_dose      369.72     187.93   1.967   0.0499 *  ***********
  anxietyGrouping_UF_R_lm <- lm(UF_R_vol ~ anxiety_dose + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_UF_R_lm)

   #R *anxiety dose + osex + age anxiety_dose          anxiety_dose      377.35     188.43   2.003    0.046 *********   
  anxietyGrouping_UF_R_by_sex_lm <- lm(UF_R_vol ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_UF_R_by_sex_lm)
  
   #UF L - anxiety_dose + age    222.193    133.138   1.669    0.096 .  
  anxietyGrouping_UF_L_lm <- lm(UF_L_vol ~ anxiety_dose + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_UF_L_lm)
  
   #UF_L anxiety_dose + sex + age:         anxiety_dose     232.210    133.294   1.742   0.0823 .  
  anxietyGrouping_UF_L_by_sex_lm <- lm(UF_L_vol ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_UF_L_by_sex_lm)
  
  #bilat anxiety dose + age: anxiety_dose     295.957    145.116   2.039   0.0421 *  
  anxietyGrouping_mean_UF_lm <- lm(mean_UF_vol ~ anxiety_dose + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_mean_UF_lm)
  
  #bilat anxiety dose + sex + age: anxiety_dose      304.78     145.39   2.096   0.0367 *  
  anxietyGrouping_mean_UF_by_sex_lm <- lm(mean_UF_vol ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_mean_UF_by_sex_lm)

  
  
#gam
  
  #UF _ R  anxiety_dose + age   357.0      188.8   1.891   0.0594 .
  anxietyGrouping_UF_R_gam <- gam(UF_R_vol ~ anxiety_dose + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_UF_R_gam)
  
 #R anxiety dose + sex + age: anxiety_dose    364.2      189.3   1.924   0.0552 .  

    anxietyGrouping_UF_R_by_sex_gam <- gam(UF_R_vol ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_UF_R_by_sex_gam)
  
   #UF_L, anxiety_dose + age    220.1      133.7   1.646    0.101    
  anxietyGrouping_UF_L_gam <- gam(UF_L_vol ~ anxiety_dose + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_UF_L_gam)
  
   #UF_L anxiety_dose + sex + age    229.9      133.9   1.717   0.0868 .  
  anxietyGrouping_UF_L_by_sex_gam <- gam(UF_L_vol ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_UF_L_by_sex_gam)
  
  #bilat
  
  #bilat  anxiety_dose + age: anxiety_dose    288.5      145.7    1.98   0.0484 *  
  anxietyGrouping_mean_UF_gam <- gam(mean_UF_vol ~ anxiety_dose + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_mean_UF_gam)
  
 #bilat anxiety dose + sex + age: anxiety_dose    297.0      146.0   2.034   0.0426 * 

    anxietyGrouping_mean_UF_by_sex_gam <- gam(mean_UF_vol ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_mean_UF_by_sex_gam)
```

##### Laterality in uncinate
```{r laterality}
  #laterality 
  #overall - t = -11.597, df = 1322.2, p-value < 2.2e-16
  right_vs_left_uncinate <- t.test(df_demo_and_fascicles_no_unclass_anxiety_dose$UF_L_vol, df_demo_and_fascicles_no_unclass_anxiety_dose$UF_R_vol)
  print(right_vs_left_uncinate)
  
  #healthy - t = -6.3298, df = 347.5, p-value = 7.577e-10
   right_vs_left_uncinate_healthy <- t.test(df_demo_and_fascicles_no_unclass_anxiety_dose$UF_L_vol[df_demo_and_fascicles_no_unclass_anxiety_dose$anxiety_dose == 0], df_demo_and_fascicles_no_unclass_anxiety_dose$UF_R_vol[df_demo_and_fascicles_no_unclass_anxiety_dose$anxiety_dose == 0])
  print(right_vs_left_uncinate_healthy)
  
  #anxietydx or meds - t = -7.7742, df = 705.18, p-value = 2.694e-14
  right_vs_left_uncinate_anxiety_or_meds <- t.test(df_demo_and_fascicles_no_unclass_anxiety_dose$UF_L_vol[df_demo_and_fascicles_no_unclass_anxiety_dose$anxiety_dose == 1], df_demo_and_fascicles_no_unclass_anxiety_dose$UF_R_vol[df_demo_and_fascicles_no_unclass_anxiety_dose$anxiety_dose == 1])
  print(right_vs_left_uncinate_anxiety_or_meds)
  
  #anxious+meds, t = -5.9638, df = 266.42, p-value = 7.804e-09
   right_vs_left_uncinate_anxiety_and_meds <- t.test(df_demo_and_fascicles_no_unclass_anxiety_dose$UF_L_vol[df_demo_and_fascicles_no_unclass_anxiety_dose$anxiety_dose == 2], df_demo_and_fascicles_no_unclass_anxiety_dose$UF_R_vol[df_demo_and_fascicles_no_unclass_anxiety_dose$anxiety_dose == 2])
  print(right_vs_left_uncinate_anxiety_and_meds)
```

### Fornix by Anxiety Dose
```{r uncinateByAnxietyDose}

#results: Anxiety dose NOT related to F_R when covarying for linear effects of age and sex, not in line with that one paper that found fornix differences

#define group
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter (anxiety_dose != 3)


########UF R - just looking at fornix by anxiety dose -NS
  anxietyGrouping_F_R_lm <- lm(F_R_vol ~ anxiety_dose + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_F_R_lm)
  
  #gam, anxiety_dose    - NS
  anxietyGrouping_F_R_gam <- gam(F_R_vol ~ anxiety_dose + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_F_R_gam)
  
  #UF _ R anxiety_dose     - NS    
  anxietyGrouping_F_R_by_sex_lm <- lm(F_R_vol ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_F_R_by_sex_lm)
  
  #gam, anxiety_dose  - NS 
    anxietyGrouping_F_R_by_sex_gam <- gam(F_R_vol ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_F_R_by_sex_gam)
  
  #UF L - anxiety_dose    - NS 
  anxietyGrouping_F_L_lm <- lm(F_L_vol ~ anxiety_dose + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_F_L_lm)
  
   #gam, anxiety_dose    - NS  
  anxietyGrouping_F_L_gam <- gam(F_L_vol ~ anxiety_dose + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_F_L_gam)
  
  #F_L anxiety_dose:NS        
  anxietyGrouping_F_L_by_sex_lm <- lm(F_L_vol ~ anxiety_dose + osex + PAT_AGE_AT_EXAM, data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_F_L_by_sex_lm)
  
   #gam, anxiety_dose - NS
  anxietyGrouping_F_L_by_sex_gam <- gam(F_L_vol ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_demo_and_fascicles_no_unclass_anxiety_dose)
  summary(anxietyGrouping_F_L_by_sex_gam)
```

### Network*Diagnosis
```{r networkxdiagnosis_groups_collapse}  

## take home: comparing healthy to has anxiety AND meds, more disease within vs outside net, anxiety vs non, no interaction.
## take home #2 : More disease in R & L uncinate in anxious versus nonanxious

  #burden of anxiety by network
  #clean up data frame
  df_empi_dx_network_proportions <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "Has.Anxietydx.OR.Antianxiety.Meds") %>%
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  mutate(Diagnosis = ifelse(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="true_healthy", "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  mutate(Anxiety_network = proportion_volume_lost_anxiety_net_by_network_size_sum_top_25) %>%
  mutate(Nonanxiety_network = proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75) %>%
  dplyr::select(subject, osex, Diagnosis, Anxiety_network, Nonanxiety_network, PAT_AGE_AT_EXAM, UF_R_vol, UF_L_vol, F_R_vol, F_L_vol) %>% 
  gather(Network, proportion_affected, -subject, -Diagnosis, -PAT_AGE_AT_EXAM, -osex, -UF_R_vol, -UF_L_vol, -F_R_vol, -F_L_vol) %>% #this is like a melt. Keeps empi and depGroupVar out of the melt
  mutate(Network = as.factor(Network)) %>%
  ungroup()
 

#simple lmer

#NetworkNonanxiety_network                      -0.246157   0.009900 173.000001 -24.864  < 2e-16 ***
#DiagnosisMS+Anxiety                             0.075874   0.030315 194.726132   2.503 0.013142 *  

disease_within_vs_outside_anxiety_net_by_dx_groups_lmer <- lmer(proportion_affected ~ Network*Diagnosis + (1|subject) + PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_dx_groups_lmer)

#Network confit:
#NetworkNonanxiety_network                     -0.265556308 -0.226758160
#DiagnosisMS+Anxiety                            0.016671783  0.135076698
confint(disease_within_vs_outside_anxiety_net_by_dx_groups_lmer)

#simple lmer
#NetworkNonanxiety_network         -0.248004   0.008994 173.000001 -27.573  < 2e-16 ***
  disease_within_vs_outside_anxiety_net_by_sex_diff_lmer <- lmer(proportion_affected ~ Network*osex + (1|subject) + PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
  summary(disease_within_vs_outside_anxiety_net_by_sex_diff_lmer)

#Network confit:
confint(disease_within_vs_outside_anxiety_net_by_sex_diff_lmer)

## diagnosis by sex 
 #simple lmer, DiagnosisMS+Anxiety         0.102015   0.030998   3.291   0.0011 ** 
disease_diagnosis_by_sex_diff_lm <- lm(proportion_affected ~ Diagnosis*osex+ PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_diagnosis_by_sex_diff_lm)

#Network confit:
confint(disease_diagnosis_by_sex_diff_lm)

#network * diagnosis + sex
#NetworkNonanxiety_network                      -0.246157   0.009900 173.000001 -24.864  < 2e-16 ***
#DiagnosisMS+Anxiety                             0.076902   0.030464 193.366257   2.524 0.012394 * 
disease_within_vs_outside_anxiety_net_by_dx_groups_sex_diff_lmer <- lmer(proportion_affected ~ Network*Diagnosis + osex + (1|subject)+ PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_dx_groups_sex_diff_lmer)

#Network confit:NetworkNonanxiety_network -0.2496593 -0.23419230
confint(disease_within_vs_outside_anxiety_net_by_dx_groups_sex_diff_lmer)

```

### Diag Effect Size * Fascicle anxiety net overlap (from depression analysis) - NOT SIG both vol and prop, only vol shown here
```{r dxEffSizeOverlapwithAnxietyNet}
#define group
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  mutate(anxiousAndMeds_or_healthy = oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  filter(anxiousAndMeds_or_healthy %in% c("true_healthy", "Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep")) %>%
  mutate(anxiousAndMeds_or_healthy = factor(anxiousAndMeds_or_healthy, levels=c("true_healthy", "Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep")))


#Positive Ts are places where anxious people have more disease than controls
fascicle_anxiety_vs_healthy_effsize <- sapply(fascicle_names_w_vol_suffix, function(fascicle) 
{

  text_for_eval <- paste0("rstatix::wilcox_effsize(df_demo_and_fascicles_no_unclass_anxiety_dose, formula = ", fascicle, " ~ anxiousAndMeds_or_healthy, paired = F, conf.level = 0.95, ci.type = \"perc\", nboot = 1000)$effsize")
  eval(parse(text=text_for_eval))
})
names(fascicle_anxiety_vs_healthy_effsize) <- fascicle_names_w_vol_suffix

#convert to data frame
df_effsize_values <- as.data.frame(fascicle_anxiety_vs_healthy_effsize)

#write.table(x = df_effsize_values, file = paste0(homedir, "results/fascicle_and_wilcox_effect_size_for_volxdx_analysis_n77.csv"), row.names = T, col.names = F, quote = F, sep = ",")


```

#### Plot effect size x Anxiety net overlap - N.S. (including if I drop all fascicles with no overlap)
``` {r plot_scatter}
#######################
### plot differences ##
#######################

#combine data frames, column 1 has names of fascicles, column 2 has Volume of overlap with anxiety network, column 3 has t-test value of anxiety vs healthy unc, 4th anxiety vs healthy fdr corrected within that fascicle

df_fascicle_anxiety_mask_volume_overlap_effsize_value <- data.frame(neurosynth_anxiety_network_fascicle_overlap$fascicle, neurosynth_anxiety_network_fascicle_overlap$non_zero_voxels_in_anxiety_map, df_effsize_values)
names(df_fascicle_anxiety_mask_volume_overlap_effsize_value) <- c("fascicle", "volume_in_anxiety_mask", "anxiety_vs_healthy_effsize")

#remove values that have no overlap
#df_fascicle_anxiety_mask_volume_overlap_effsize_value <- df_fascicle_anxiety_mask_volume_overlap_effsize_value

# plot fascicle overlap x Eff size value
#statistic, 
anxiety_overlap_x_anxiety_vs_healthy_vol_effsize <- lm(anxiety_vs_healthy_effsize ~ volume_in_anxiety_mask, data=df_fascicle_anxiety_mask_volume_overlap_effsize_value )
summary(anxiety_overlap_x_anxiety_vs_healthy_vol_effsize)


scatter_effsize_val_by_anxiety_net_overlap_log <- ggplot(data=df_fascicle_anxiety_mask_volume_overlap_effsize_value, aes(x=volume_in_anxiety_mask, y=anxiety_vs_healthy_effsize, color=anxiety_vs_healthy_effsize)) +
  geom_point(size=2) + 
  scale_color_gradient(low = "#FFFFFF", high = "#ff00ff") +
  geom_smooth(formula = y ~ x, method=lm, color="black")+
  scale_x_continuous(trans=scales::pseudo_log_trans(base = 10), breaks=c(0, 10, 100, 1000, 10000, 100000)) + 
  xlab("Volume of Fascicle in Anxiety Network") + 
  ylab("Effect Size (r)") + 
  theme(plot.title=element_text(hjust=0.5),
        axis.text = element_text(size=16, color = "black"),
        axis.title = element_text(size=18, color = "black"),
        axis.line = element_line(color="black", size=1.3),
        panel.background = element_blank(),
        legend.position = "none",
        aspect.ratio = 4/4) + 
  annotate("text", x=1.6, y=0.14, size = 5, 
           label = paste0("P = ", round(summary(anxiety_overlap_x_anxiety_vs_healthy_vol_effsize)$coef[2,4],2))) 

print(scatter_effsize_val_by_anxiety_net_overlap_log)

#save as pdf
#pdf(file=paste0(homedir, "/results/Figures_for_msanxietyn_paper/scatter_effsize_val_by_anxiety_net_overlap_log.pdf"))
 # scatter_effsize_val_by_anxiety_net_overlap_log
#dev.off()

#df_for_making_colors <- df_fascicle_anxiety_mask_volume_overlap_effsize_value %>% dplyr::select(fascicle, anxiety_vs_healthy_effsize)
#write.table(x = df_for_making_colors, file = paste0(homedir, "results/fascicle_and_effect_size_for_volxdx_analysis_n77.csv"), row.names = F, col.names = F, quote = F, sep = ",")

```

### Sex Differences
```{r diseaseXsexdiff}
############## sex diff
#df_anxiety_disorder_by_sex <- 

#define group
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter (anxiety_dose != 3)


###### Sex differences - NONE. important because anxiety dx usually have differences

## in anxiety diagnosis

#####FIRST, SEX DIFF IN FREQUENCY OF ILLNESS - no diff between groups

#first number is # with anxiety, second is number without anxiety
anxiety_female_0 <-df_demo_and_fascicles_no_unclass_anxiety_dose %>% filter(anxiety_dose == 0 & osex == "Female") %>% count()
anxiety_total_0 <-df_demo_and_fascicles_no_unclass_anxiety_dose %>% filter(anxiety_dose == 0) %>% count()
anxiety_female_1 <-df_demo_and_fascicles_no_unclass_anxiety_dose %>% filter(anxiety_dose == 1 & osex == "Female") %>% count()
anxiety_total_1 <-df_demo_and_fascicles_no_unclass_anxiety_dose %>% filter(anxiety_dose == 1) %>% count()
anxiety_female_2 <- df_demo_and_fascicles_no_unclass_anxiety_dose %>% filter(anxiety_dose == 2 & osex == "Female") %>% count()
anxiety_total_2 <- df_demo_and_fascicles_no_unclass_anxiety_dose %>% filter(anxiety_dose == 2) %>% count()

#make table
num_w_anxiety_female <- as.numeric(c(anxiety_female_0, anxiety_female_1, anxiety_female_2))
num_total <-as.numeric(c(anxiety_total_0,anxiety_total_1, anxiety_total_2))
df_2x3_anxiety_score_by_total_people_per_diagnosis <- data.frame(cbind(num_w_anxiety_female, num_total), row.names = c("MS+AnxietyandMed", "MS+AnxietyorMed", "MS-Anxiety"))

#X-squared (Pearson's) X-squared = 0.19886, df = 2, p-value = 0.9054
chisq_anxiety_dose <- chisq.test(df_2x3_anxiety_score_by_total_people_per_diagnosis)
chisq_anxiety_dose

#just healthy and super anxious/sick, X-squared = 0.056046, df = 1, p-value = 0.8129
num_w_anxiety_female_just_healthy_and_sick <- as.numeric(c(anxiety_female_0, anxiety_female_2))
num_total_just_healthy_and_sick <-as.numeric(c(anxiety_total_0,anxiety_total_2))
df_2x2_anxiety_score_by_total_people_per_diagnosis_num_total_just_healthy_and_sick <- data.frame(cbind(num_w_anxiety_female_just_healthy_and_sick, num_total_just_healthy_and_sick), row.names = c("MS+AnxietyandMed", "MS-Anxiety"))

chisq_healthy_vs_sick <- chisq.test(df_2x2_anxiety_score_by_total_people_per_diagnosis_num_total_just_healthy_and_sick)
chisq_healthy_vs_sick





#frequency_diff_between_sexes <- chisq.test(df_demo_and_fascicles$Has.Anxietydx.AND.Antianxietymed, df_demo_and_fascicles$osex)

#simple lmer across whole network

#overall - NS
disease_between_sexes <- lm(proportion_volume_lost_per_total_network_size_sum ~ osex+ PAT_AGE_AT_EXAM, data = df_demo_and_fascicles_no_unclass_anxiety_dose)
summary(disease_between_sexes)

### anxiety net NS
disease_between_sexes_anxiety_net <- lm(proportion_volume_lost_anxiety_net_by_network_size_sum ~ osex+ PAT_AGE_AT_EXAM, data = df_demo_and_fascicles_no_unclass_anxiety_dose)
summary(disease_between_sexes_anxiety_net)

### nonanxiety net - NS
disease_between_sexes_nonanxiety_net <- lm(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ osex+ PAT_AGE_AT_EXAM, data = df_demo_and_fascicles_no_unclass_anxiety_dose)
summary(disease_between_sexes_nonanxiety_net)

#uncinate R- NS
disease_between_sexes_UF_R <- lm(UF_R_vol ~ osex+ PAT_AGE_AT_EXAM, data = df_demo_and_fascicles_no_unclass_anxiety_dose)
summary(disease_between_sexes_UF_R)

#uncinate L - ns
disease_between_sexes_UF_L <- lm(UF_L_vol ~ osex+ PAT_AGE_AT_EXAM, data = df_demo_and_fascicles_no_unclass_anxiety_dose)
summary(disease_between_sexes_UF_L)

```

### Age*Disease
```{r diagnosisXage}

#define group
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(anxiety_dose != 3) %>%
  mutate(anxiety_dose_factor = ordered(anxiety_dose))


### diagnosis by age interaction?
#overall - NS
diagnosis_by_age <- lm(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose*PAT_AGE_AT_EXAM, data = df_demo_and_fascicles_no_unclass_anxiety_dose)
summary(diagnosis_by_age)

#gam dose
diagnosis_by_age_gam <- gam(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose+s(PAT_AGE_AT_EXAM, by = anxiety_dose), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_gam)
summary(diagnosis_by_age_gam)$s.table
#plot(diagnosis_by_age_gam)

#gam factor - there is a linear dose effect per network size sum, as well as a sig age by anxiety relationship, but only in sick people
diagnosis_by_age_gam_factor <- gam(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose_factor+s(PAT_AGE_AT_EXAM, by = anxiety_dose_factor), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_gam_factor)
summary(diagnosis_by_age_gam_factor)$s.table
#plot(diagnosis_by_age_gam_factor)

#plot proportion_volume_lost_per_total_network_size_sum
plot_smooths_proportion_volume_lost_per_total_network_size_sum <- plot_smooths(
  model = diagnosis_by_age_gam_factor,
  series = PAT_AGE_AT_EXAM,
  comparison = anxiety_dose_factor
) +
  theme(legend.position = "top")
plot_smooths_proportion_volume_lost_per_total_network_size_sum

####. within/outside anxiety network #######
#dose
diagnosis_by_age_anx_net_gam <- gam(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose+s(PAT_AGE_AT_EXAM, by = anxiety_dose), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_anx_net_gam)
summary(diagnosis_by_age_anx_net_gam)$s.table
#plot(diagnosis_by_age_anx_net_gam)

#factor
diagnosis_by_age_anx_net_gam_factor <- gam(proportion_volume_lost_anxiety_net_by_network_size_sum_top_25 ~ anxiety_dose_factor+s(PAT_AGE_AT_EXAM, by = anxiety_dose_factor), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_anx_net_gam_factor)
summary(diagnosis_by_age_anx_net_gam_factor)$s.table
#plot(diagnosis_by_age_anx_net_gam_factor)

#gam plot diagnosis_by_age_anx_net_gam_factor

plot_smooths_diagnosis_by_age_anx_net_gam_factor <- plot_smooths(
  model = diagnosis_by_age_anx_net_gam_factor,
  series = PAT_AGE_AT_EXAM,
  comparison = anxiety_dose_factor
) +
  theme(legend.position = "top")
plot_smooths_diagnosis_by_age_anx_net_gam_factor


##### #outside each network

##dose
diagnosis_by_age_nonanx_net_gam <- gam(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose+s(PAT_AGE_AT_EXAM, by = anxiety_dose), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_nonanx_net_gam)
summary(diagnosis_by_age_nonanx_net_gam)$s.table
#plot(diagnosis_by_age_nonanx_net_gam)

#factor

diagnosis_by_age_nonanx_net_gam_factor <- gam(proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75 ~ anxiety_dose_factor+s(PAT_AGE_AT_EXAM, by = anxiety_dose_factor), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_nonanx_net_gam_factor)
summary(diagnosis_by_age_nonanx_net_gam_factor)$s.table
#plot(diagnosis_by_age_nonanx_net_gam_factor)

#gam plot diagnosis_by_age_nonanx_net_gam_factor

plot_smooths_diagnosis_by_age_nonanx_net_gam_factor <- plot_smooths(
  model = diagnosis_by_age_nonanx_net_gam_factor,
  series = PAT_AGE_AT_EXAM,
  comparison = anxiety_dose_factor
) +
  theme(legend.position = "top")
plot_smooths_diagnosis_by_age_nonanx_net_gam_factor


### uncinate right

#dose
diagnosis_by_age_UF_R_gam <- gam(UF_R_vol ~ anxiety_dose+s(PAT_AGE_AT_EXAM, by = anxiety_dose), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_UF_R_gam)
summary(diagnosis_by_age_UF_R_gam)$s.table
#plot(diagnosis_by_age_UF_R_gam)

#factor
diagnosis_by_age_UF_R_gam_factor <- gam(UF_R_vol ~ anxiety_dose_factor+s(PAT_AGE_AT_EXAM, by = anxiety_dose_factor), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_UF_R_gam_factor)
summary(diagnosis_by_age_UF_R_gam_factor)$s.table
#plot(diagnosis_by_age_UF_R_gam_factor)

#gam UF_R plot

plot_smooths_anxiety_dose_by_age_UF_R <- plot_smooths(
  model = diagnosis_by_age_UF_R_gam_factor,
  series = PAT_AGE_AT_EXAM,
  comparison = anxiety_dose_factor
) +
  theme(legend.position = "top")
plot_smooths_anxiety_dose_by_age_UF_R

#uncinate left
#dose
diagnosis_by_age_UF_L_gam <- gam(UF_L_vol ~ anxiety_dose+s(PAT_AGE_AT_EXAM, by = anxiety_dose), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_UF_L_gam)
summary(diagnosis_by_age_UF_L_gam)$s.table
#plot(diagnosis_by_age_UF_L_gam)

#factor
diagnosis_by_age_UF_L_gam_factor <- gam(UF_L_vol ~ anxiety_dose_factor+s(PAT_AGE_AT_EXAM, by = anxiety_dose_factor), data = df_demo_and_fascicles_no_unclass_anxiety_dose, method = "REML")
summary(diagnosis_by_age_UF_L_gam_factor)
summary(diagnosis_by_age_UF_L_gam_factor)$s.table
#plot(diagnosis_by_age_UF_L_gam_factor)

#gam UF_L plot

plot_smooths_anxiety_dose_by_age_UF_L <- plot_smooths(
  model = diagnosis_by_age_UF_L_gam_factor,
  series = PAT_AGE_AT_EXAM,
  comparison = anxiety_dose_factor
) +
  theme(legend.position = "top")
plot_smooths_anxiety_dose_by_age_UF_L

## Sex diff trajectories by age
#overall - NS
sex_by_age <- lm(proportion_volume_lost_per_total_network_size_sum ~ osex*PAT_AGE_AT_EXAM, data = df_demo_and_fascicles_no_unclass_anxiety_dose)
summary(sex_by_age)


```


### Individual Fascicle disease

#### healthy vs super sick - values that fdr correct, most not anxiety net
```{r individual_fascicle_disease_healthy_vs_super_sick}
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  mutate(anxiousAndMeds_or_healthy = oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  filter(anxiousAndMeds_or_healthy %in% c("true_healthy", "Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep")) %>%
  mutate(anxiousAndMeds_or_healthy = factor(anxiousAndMeds_or_healthy, levels=c("true_healthy", "Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep")))

#lm
fascicle_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ anxiousAndMeds_or_healthy + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = df_demo_and_fascicles_no_unclass_anxiety_dose)
})
names(fascicle_lm) <- fascicle_names_w_prop_suffix

#anova
fascicle_anova <- lapply(fascicle_lm, anova)


#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
#fascicle_anova_w_fiber_mapping <- fascicle_agesex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
##fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc) 
```

#### Parametric all fascicles
```{r individual_fascicle_disease_healthy_vs_super_sick}
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(anxiety_dose != 3) %>%
  mutate(anxiety_dose_factor = ordered(anxiety_dose))

#lm
fascicle_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = df_demo_and_fascicles_no_unclass_anxiety_dose)
})
names(fascicle_lm) <- fascicle_names_w_prop_suffix

#anova
fascicle_anova <- lapply(fascicle_lm, anova)


#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
#fascicle_anova_w_fiber_mapping <- fascicle_agesex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
##fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc) 
```
#### Parametric anxiety net fascicles
```{r individual_fascicle_disease_healthy_vs_super_sick}
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(anxiety_dose != 3) %>%
  mutate(anxiety_dose_factor = ordered(anxiety_dose))

#lm
fascicle_lm <- lapply(fascicle_names_top_25_prop_w_suff, function(x) 
{
  lm(substitute(i ~ oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = df_demo_and_fascicles_no_unclass_anxiety_dose)
})
names(fascicle_lm) <- fascicle_names_top_25_prop_w_suff

#anova
fascicle_anova <- lapply(fascicle_lm, anova)


#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
#fascicle_anova_w_fiber_mapping <- fascicle_agesex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
##fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc) 
```

#### Parametric nonanxiety net fascicles
```{r individual_fascicle_disease_healthy_vs_super_sick}
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(anxiety_dose != 3) %>%
  mutate(anxiety_dose_factor = ordered(anxiety_dose))

#lm
fascicle_lm <- lapply(fascicle_names_bottom_75_prop_w_suff, function(x) 
{
  lm(substitute(i ~ oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = df_demo_and_fascicles_no_unclass_anxiety_dose)
})
names(fascicle_lm) <- fascicle_names_bottom_75_prop_w_suff

#anova
fascicle_anova <- lapply(fascicle_lm, anova)


#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
#fascicle_anova_w_fiber_mapping <- fascicle_agesex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
##fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc) 
```

### Plots 

##### Overall disease, within and outside anxiety net
```{r}
prop_injured_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x= oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed , y=proportion_volume_lost_per_total_network_size_sum, fill= oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed )) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_by_anxiety_burden_collapsed_vars_plot

  #proportion injured over anxiety net
prop_injured_anxiety_net_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x=oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed, y=proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, fill=oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_anxiety_net_by_anxiety_burden_collapsed_vars_plot

  #proportion injured over nonanxiety net
prop_injured_nonanxiety_net_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x=oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed, y=proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75, fill=oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_nonanxiety_net_by_anxiety_burden_collapsed_vars_plot
```

##### Plots Uncinate R& L Prop
```{r plots_uncinate}
  #proportion injured over R Uncinate prop
prop_injured_R_uncinate_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x=oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed, y=UF_R_prop, fill=oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_R_uncinate_by_anxiety_burden_collapsed_vars_plot

 #proportion injured over R Uncinate prop - geom_bar
means_by_anxiety_dose <- c(mean(df_disease_burden_unc_and_anx_net_collapsed_variables$UF_R_prop[df_disease_burden_unc_and_anx_net_collapsed_variables$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="true_healthy"]),
                                mean(df_disease_burden_unc_and_anx_net_collapsed_variables$UF_R_prop[df_disease_burden_unc_and_anx_net_collapsed_variables$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="Has.Anxietydx.OR.Antianxiety.Meds"]),
                                mean(df_disease_burden_unc_and_anx_net_collapsed_variables$UF_R_prop[df_disease_burden_unc_and_anx_net_collapsed_variables$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep"]))

df_UF_R_mean_by_anxiety_dose <- data.frame(cbind(means_by_anxiety_dose, c("true_healthy", "Has.Anxietydx.OR.Antianxiety.Meds", "Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep")))

names(df_UF_R_mean_by_anxiety_dose) <- c("mean_UF_R", "Anxiety_dose")

df_UF_R_mean_by_anxiety_dose <- df_UF_R_mean_by_anxiety_dose %>%
  mutate(mean_UF_R = as.numeric(mean_UF_R)) %>%
  mutate(Anxiety_dose = factor(Anxiety_dose, levels = unique(Anxiety_dose)))
                        
prop_injured_R_uncinate_by_anxiety_burden_collapsed_vars_plot_bar <-  ggplot(df_UF_R_mean_by_anxiety_dose, aes(x=Anxiety_dose, y=mean_UF_R, fill=Anxiety_dose)) +
  geom_bar(stat="identity") +  
  ylim(0,0.5)+
#  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5),
        panel.background = element_rect(colour = "white", fill = "white"))
prop_injured_R_uncinate_by_anxiety_burden_collapsed_vars_plot_bar


  #proportion injured over L Uncinate prop
prop_injured_L_uncinate_by_anxiety_burden_collapsed_vars_plot <-  ggplot(df_disease_burden_unc_and_anx_net_collapsed_variables, aes(x=oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed, y=UF_L_prop, fill=oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5))
prop_injured_L_uncinate_by_anxiety_burden_collapsed_vars_plot



 #proportion injured over R Uncinate prop - geom_bar
means_by_anxiety_dose <- c(mean(df_disease_burden_unc_and_anx_net_collapsed_variables$UF_L_prop[df_disease_burden_unc_and_anx_net_collapsed_variables$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="true_healthy"]),
                                mean(df_disease_burden_unc_and_anx_net_collapsed_variables$UF_L_prop[df_disease_burden_unc_and_anx_net_collapsed_variables$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="Has.Anxietydx.OR.Antianxiety.Meds"]),
                                mean(df_disease_burden_unc_and_anx_net_collapsed_variables$UF_L_prop[df_disease_burden_unc_and_anx_net_collapsed_variables$oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep"]))

df_UF_L_mean_by_anxiety_dose <- data.frame(cbind(means_by_anxiety_dose, c("true_healthy", "Has.Anxietydx.OR.Antianxiety.Meds", "Has.Anxiety.And.On.Anxiety.Meds.Inc.Dep")))

names(df_UF_L_mean_by_anxiety_dose) <- c("mean_UF_L", "Anxiety_dose")

df_UF_R_mean_by_anxiety_dose <- df_UF_L_mean_by_anxiety_dose %>%
  mutate(mean_UF_L = as.numeric(mean_UF_L)) %>%
  mutate(Anxiety_dose = factor(Anxiety_dose, levels = unique(Anxiety_dose)))
                        
prop_injured_L_uncinate_by_anxiety_burden_collapsed_vars_plot_bar <-  ggplot(df_UF_R_mean_by_anxiety_dose, aes(x=Anxiety_dose, y=mean_UF_L, fill=Anxiety_dose)) +
  geom_bar(stat="identity") +  
  ylim(0,0.5)+
#  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  theme(axis.text.x = element_text(size=8, angle = 45, vjust = 0.5),
        panel.background = element_rect(colour = "white", fill = "white"))
prop_injured_L_uncinate_by_anxiety_burden_collapsed_vars_plot_bar
```



##Plot within vs outside network
```{r plottting_bar_graph}

#Within vs outside network
anxiety_net_group <- c(rep("Anxiety Network", times = dim(df_demo_and_fascicles)[1]), rep("Nonanxiety Network",times =dim(df_demo_and_fascicles)[1]))
net_values <- c(df_demo_and_fascicles$proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, df_demo_and_fascicles$proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75)

newdf <- data.frame(anxiety_net_group, net_values)

newdf <- newdf %>%
  mutate( anxiety_net_group=factor(anxiety_net_group,levels=c( "Nonanxiety Network", "Anxiety Network")))

violin_within_vs_outside_network_sum_proportion_scaled_by_network_size <- ggplot(newdf, aes(x=anxiety_net_group, y=net_values, fill=anxiety_net_group)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  ggtitle(paste0("Volume of Fascicle Disease Burden")) +
  ylab("Proportion of network affected") +
  ylim(0,1) + 
  scale_fill_manual(values=c("#D3D3D3", "#841DE2")) +
  theme(plot.title = element_text(size=16, hjust = 0.55),
        axis.text = element_text(size = 16, colour = "black"), axis.title.y  = element_blank(), 
        axis.title.x = element_text(size=16),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        legend.position = "none",
        aspect.ratio=4/7,
        panel.background = element_rect(colour = "white", fill = "white")) + 
  coord_flip() 

#display
violin_within_vs_outside_network_sum_proportion_scaled_by_network_size
```

## Anxiety net defined as (25 vol x 25 prop anxiety net) -> no better, don't use
### Anxiety and Non anxiety net by dose 
```{r anxiety_and_nonanxiety_net_by_dose}

### Will be using gam + s(age) and osex because this was giving me most robust findings previously.
### I know that we already have an effect in across whole brain. Now i want to check if it differs within new anxiety net vs outside

df_disease_burden_unc_and_anx_net_collapsed_variables <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>% 
  dplyr::select(proportion_volume_lost_per_total_network_size_sum, proportion_fascicle_volume_lost_top_25_vol_x_top_25_prop, proportion_fascicle_vol_lost_NOT_top_25_vol_x_top_25_prop, UF_L_prop, UF_R_prop, oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed, osex, anxiety_dose, PAT_AGE_AT_EXAM) 

## gam, check original finding still there, anxiety_dose  0.03692    0.01496   2.468    0.014 *  
   anxietyGrouping_cov_sex_gam <- gam(proportion_volume_lost_per_total_network_size_sum ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_disease_burden_unc_and_anx_net_collapsed_variables)
  summary(anxietyGrouping_cov_sex_gam)
  
  #gam, anxiety_dose, anxiety net, anxiety_dose  0.027830   0.015810   1.760   0.0792 . 
   anxietyGrouping_cov_sex_anxiety_net_gam <- gam(proportion_fascicle_volume_lost_top_25_vol_x_top_25_prop ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_disease_burden_unc_and_anx_net_collapsed_variables)
  summary(anxietyGrouping_cov_sex_anxiety_net_gam)
  
    #gam, anxiety_dose, non anxiety net; anxiety_dose  0.03814    0.01500   2.543   0.0114 *  
   anxietyGrouping_cov_sex_nonanxiety_net_gam <- gam(proportion_fascicle_vol_lost_NOT_top_25_vol_x_top_25_prop ~ anxiety_dose + osex + s(PAT_AGE_AT_EXAM, k = 4, fx = T), data=df_disease_burden_unc_and_anx_net_collapsed_variables)
  summary(anxietyGrouping_cov_sex_nonanxiety_net_gam)


```

### Network*Diagnosis 
```{r networkxdiagnosis_groups_collapse}  

## take home: comparing healthy to has anxiety AND meds, more disease within vs outside net, anxiety vs non, no interaction.
## take home #2 : More disease in R & L uncinate in anxious versus nonanxious
## take home #3 : About the same results as using the previously described anxiety net (rather than the vol 25 x 25 prop)

  #burden of anxiety by network
  #clean up data frame
 df_empi_dx_network_proportions <- df_demo_and_fascicles %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "unclassified") %>%
  filter(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed != "Has.Anxietydx.OR.Antianxiety.Meds") %>%
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed) %>%
  mutate(Diagnosis = ifelse(oanxietydx_OR_meds_AND_Anxietydx.Meds.And.Dep.True.Healthy.Collapsed=="true_healthy", "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  
  #### only two lines that are changed from normal Network * Diagnosis analysis
  mutate(Anxiety_network = proportion_fascicle_vol_lost_top_25_vol_x_top_25_prop) %>%
  mutate(Nonanxiety_network = proportion_fascicle_vol_lost_NOT_top_25_vol_x_top_25_prop) %>%
  #### End changes ###
  
  dplyr::select(subject, osex, Diagnosis, Anxiety_network, Nonanxiety_network, PAT_AGE_AT_EXAM, UF_R_vol, UF_L_vol, F_R_vol, F_L_vol) %>% 
  gather(Network, proportion_affected, -subject, -Diagnosis, -PAT_AGE_AT_EXAM, -osex, -UF_R_vol, -UF_L_vol, -F_R_vol, -F_L_vol) %>% #this is like a melt. Keeps empi and depGroupVar out of the melt
  mutate(Network = as.factor(Network)) %>%
  ungroup()


 #simple lmer
#NetworkNonanxiety_network                      -0.138487   0.008276 173.000010 -16.733  < 2e-16 ***
#DiagnosisMS+Anxiety                             0.058186   0.029606 188.395804   1.965 0.050843 .  

disease_within_vs_outside_anxiety_net_by_dx_groups_lmer <- lmer(proportion_affected ~ Network*Diagnosis + (1|subject) + PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_dx_groups_lmer)

#Network confit
confint(disease_within_vs_outside_anxiety_net_by_dx_groups_lmer)


#simple lmer
#NetworkNonanxiety_network         -0.124175   0.007485 173.000000 -16.589  < 2e-16 ***
#osex.L                             0.009908   0.025201 187.843641   0.393 0.694647   

  disease_within_vs_outside_anxiety_net_by_sex_diff_lmer <- lmer(proportion_affected ~ Network*osex + (1|subject) + PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
  summary(disease_within_vs_outside_anxiety_net_by_sex_diff_lmer)

#Network confit:
confint(disease_within_vs_outside_anxiety_net_by_sex_diff_lmer)

## diagnosis by sex 
 #simple lmer, DiagnosisMS+Anxiety         0.0989168  0.0269866   3.665 0.000286 ***
disease_diagnosis_by_sex_diff_lm <- lm(proportion_affected ~ Diagnosis*osex+ PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_diagnosis_by_sex_diff_lm)

#Network confit:
confint(disease_diagnosis_by_sex_diff_lm)


#network * diagnosis + sex
 #simple lmer: 
#NetworkNonanxiety_network                      -0.138487   0.008276 173.000010 -16.733  < 2e-16 ***
#DiagnosisMS+Anxiety                             0.058522   0.029769 187.116974   1.966 0.050793 .   
disease_within_vs_outside_anxiety_net_by_dx_groups_sex_diff_lmer <- lmer(proportion_affected ~ Network*Diagnosis + osex + (1|subject)+ PAT_AGE_AT_EXAM, data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_dx_groups_sex_diff_lmer)

#Network confit
confint(disease_within_vs_outside_anxiety_net_by_dx_groups_sex_diff_lmer)


```

## AnxietydxANDbenzoGroupVar within/outside network
```{r anxiety_net_intx}

## demographics


### demographics
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles)
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles[df_demo_and_fascicles$anxietydxANDbenzoGroupVar != 0,])


#clean up data frame
df_empi_dx_network_proportions <- df_demo_and_fascicles %>%
  filter(anxietydxANDbenzoGroupVar != 0) %>% #lose 150, n now 662
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = ifelse(anxietydxANDbenzoGroupVar==1, "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  mutate(Has.anxietydx = as.factor(Has.anxietydx)) %>%
  mutate(Anxiolytics_status = ifelse(On.Anxiolytics_no_beta_blocker==1, "On.Anxiolytics", "Off.Anxiolytics")) %>%
  mutate(Anxiolytics_status = as.factor(Anxiolytics_status)) %>%
  mutate(Benzo_status = ifelse(On.Benzos==1, "On.Benzos", "Off.Benzos")) %>%
  mutate(Benzo_status = as.factor(Benzo_status)) %>%
  mutate(Anxiety_network = proportion_volume_lost_anxiety_net_by_network_size_sum_top_25) %>%
  mutate(Nonanxiety_network = proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75) %>%
  dplyr::select(subject, osex, Diagnosis, Anxiety_network, Nonanxiety_network, Anxiolytics_status, Has.anxietydx, Benzo_status, PAT_AGE_AT_EXAM) %>% 
  gather(Network, proportion_affected, -subject, -Diagnosis, -PAT_AGE_AT_EXAM, -osex, -Anxiolytics_status, -Has.anxietydx, -Benzo_status) %>% #this is like a melt. Keeps empi and depGroupVar out of the melt
  mutate(Network = as.factor(Network)) %>%
  ungroup()
 
#MS+Anxiety, MS-Anxiety, benzos + anxiety dx, true normal = 0.3782694; MS+ anxiety: ; MS-anxiety: 0.3672053
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"])
t.test(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"], df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"], paired = F)

#histos
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], main = "Anxiety Network Injury", xlab = "Proportion Affected")
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], main = "Nonanxiety Network Injury", xlab = "Proportion Affected")

## Means of separate groups: 

#t test, t; t = 61.356, df = 661, p-value < 2.2e-16; 95 percent confidence interval:0.2341835 0.2496681
within_vs_outside_anxiety_net_t <- t.test(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], paired = T)
summary(within_vs_outside_anxiety_net_t)

 #simple lmer, NetworkNonanxiety_network  -0.241926   0.003943 661.000022  -61.36   <2e-16 ***
disease_within_vs_outside_anxiety_net_lmer <- lmer(proportion_affected ~ Network + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_lmer)

#Network confit:NetworkNonanxiety_network -0.2496593 -0.23419230
confint(disease_within_vs_outside_anxiety_net_lmer)

#diagnosis: NS; DiagnosisMS+Anxiety T=  0.811, p=    0.418    ; NetworkNonanxiety_network T= -49.984   p<2e-16 ***
diagnosis_by_network_interaction_lmer <- lmer(proportion_affected ~ Diagnosis*Network + (1|subject), data = df_empi_dx_network_proportions)
summary(diagnosis_by_network_interaction_lmer)

#Diagnosis: NS
confint(diagnosis_by_network_interaction_lmer)

## Anxiety network x anxiolytics status
#Network (nonanxiety <anxiety network) : 
# anxiolytic status: Anxiolytics_statusOn.Anxiolytics 0.064088   0.031256 736.439692    2.05   0.0407 *  
#Mean prop affected: 

disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer <- lmer(proportion_affected ~ Network*Anxiolytics_status + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer)
confint(disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer)

## Anxiety network x benzo status
#Network (nonanxiety <anxiety network) -59.082   <2e-16; Anxiety status: T = 1.210    P = 0.227

disease_within_vs_outside_anxiety_net_by_benzo_lmer <- lmer(proportion_affected ~ Network*Benzo_status + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_benzo_lmer)
confint(disease_within_vs_outside_anxiety_net_by_benzo_lmer)

## Anxiety network x anxiety diagnosis
#Network (nonanxiety <anxiety network) :  -51.733   <2e-16 *** ; Anxiety status:  0.721    0.471

disease_within_vs_outside_anxiety_net_by_anxietydx_lmer <- lmer(proportion_affected ~ Network*Has.anxietydx + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_anxietydx_lmer)
confint(disease_within_vs_outside_anxiety_net_by_anxietydx_lmer)
```




## Anxiety network interaction, matching groups 
```{r anxiety_net_intx}

## demographics


### BEST SPLIT IS STRATIFYING ON ANXIETY MEDS!!!! Better than on variable that includes anxietyGroupVar(meds + anxiety diagnoses), or anxiety diagnosis alone
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles)
make_demographics_table_ms_anxiety(data_frame = df_demo_and_fascicles[df_demo_and_fascicles$anxietyGroupVar != 0,])


#clean up data frame
df_prematched <- df_demo_and_fascicles %>%
  filter(anxietyGroupVar != 0) %>% #lose 93, n now 719
  mutate(anxietyGroupVar = as.factor(anxietyGroupVar)) %>%
  mutate(subject = as.factor(EMPI)) %>%
  mutate(Diagnosis = ifelse(anxietyGroupVar==1, "MS-Anxiety", "MS+Anxiety")) %>%
  mutate(Diagnosis = as.factor(Diagnosis)) %>%
  mutate(Has.anxietydx = as.factor(Has.anxietydx)) %>%
  mutate(Anxiolytics_status = ifelse(On.Anxiolytics_no_beta_blocker==1, "On.Anxiolytics", "Off.Anxiolytics")) %>%
  mutate(Anxiolytics_status = as.factor(Anxiolytics_status)) %>%
  mutate(Benzo_status = ifelse(On.Benzos==1, "On.Benzos", "Off.Benzos")) %>%
  mutate(Benzo_status = as.factor(Benzo_status)) %>%
  mutate(Anxiety_network = proportion_volume_lost_anxiety_net_by_network_size_sum_top_25) %>%
  mutate(Nonanxiety_network = proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75) %>%
  ungroup()

#Do the match
### first, check the prematched data, can play with which variable I want to match on, Has.anxietydx, anxietyGroupVar, Anxiolytics_status
m.out.prematched <- matchit(anxietyGroupVar ~ sex_binarized + PAT_AGE_AT_EXAM , data = df_prematched,
                 method = NULL, distance = "glm")
summary(m.out.prematched)

#then, do the match with the "nearest" method
m.out.matched <-  matchit(anxietyGroupVar ~ sex_binarized + PAT_AGE_AT_EXAM , data = df_prematched,
                 method = "nearest", distance = "glm")

#display output
summary(m.out.matched, un = FALSE)


#add column for keeping to the prematched data frame
df_prematched$keep <- m.out.matched$weights

#drop values to not keep

df_matched <- df_prematched %>% filter(keep == 1)

### check demographics
make_demographics_table_ms_anxiety(data_frame = df_matched)


  

df_empi_dx_network_proportions <-  df_matched %>%
  dplyr::select(subject, osex, Diagnosis, Anxiety_network, Nonanxiety_network, Anxiolytics_status, Has.anxietydx, Benzo_status, PAT_AGE_AT_EXAM) %>% 
  gather(Network, proportion_affected, -subject, -Diagnosis, -PAT_AGE_AT_EXAM, -osex, -Anxiolytics_status, -Has.anxietydx, -Benzo_status) %>% #this is like a melt. Keeps empi and depGroupVar out of the melt
  mutate(Network = as.factor(Network)) %>%
  ungroup()
 
#simple t test, disease within versus outside anxiety network; mean within anxiety net: 0.5426694 affected, mean outside anxiety network = 0.3062429, T=57.44, p<2.2*10^-16, 95% CI 0.22-0.24
#MS+Anxiety, MS-Anxiety, meds + anxiety dx, true normal = 0.3850697; MS+ anxiety: ; MS-anxiety: 0.3672053
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS+Anxiety"])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Diagnosis == "MS-Anxiety"])

#Anxiety dx vs no anxiety dx
#anxiety dx: 0.3785979; no anxiety dx: 0.3723245
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Has.anxietydx==1])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Has.anxietydx==0])

#On.Anxiolytics vs Off.Anxiolytics
#on anxiolytics: 0.415625; off anxiolytics:0.3664898
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Anxiolytics_status=="On.Anxiolytics"])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Anxiolytics_status=="Off.Anxiolytics"])

#On.Benzos vs Off.Benzos
#on benzos: 0.4022933; off benzos:0.372135
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Benzo_status=="On.Benzos"])
mean(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Benzo_status=="Off.Benzos"])

#histos
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"])
hist(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"])

## Means of separate groups: 

#t test, t = 63.621, df = 718, p-value < 2.2e-16; 95 percent confidence interval:0.2349467 0.2499088, mean diff: 0.2424277 
within_vs_outside_anxiety_net_t <- t.test(df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Anxiety_network"], df_empi_dx_network_proportions$proportion_affected[df_empi_dx_network_proportions$Network == "Nonanxiety_network"], paired = T)
summary(within_vs_outside_anxiety_net_t)

 #simple lmer, confirms T; -63.62   <2e-16 ***
disease_within_vs_outside_anxiety_net_lmer <- lmer(proportion_affected ~ Network + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_lmer)

 #Net by sex, confirms T; -63.62   <2e-16, but no sex differences (p=0.179)
disease_within_vs_outside_anxiety_net_sex_lmer <- lmer(proportion_affected ~ Network +osex + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_sex_lmer)

 #simple lmer, confirms network: -63.621  < 2e-16 , Pat age: 6.338 4.12e-10
disease_within_vs_outside_anxiety_net_age_lmer <- lmer(proportion_affected ~ Network + PAT_AGE_AT_EXAM + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_age_lmer)

#Age * network interaction, don't know if this is valid at all. outside > w/in net: -12.718  < 2e-16 ***; pat age = 6.837  1.6e-11 ***, NetworkNonanxiety_network:PAT_AGE_AT_EXAM -2.852  0.00447 
disease_within_vs_outside_anxiety_net_age_intx_lmer <- lmer(proportion_affected ~ Network*PAT_AGE_AT_EXAM + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_age_intx_lmer)

#diagnosis: NS
diagnosis_by_network_interaction_lmer <- lmer(proportion_affected ~ Diagnosis*Network + (1|subject), data = df_empi_dx_network_proportions)
summary(diagnosis_by_network_interaction_lmer)

#Diagnosis: NS
confint(diagnosis_by_network_interaction_lmer)

## Anxiety network x anxiolytics status
#Network (nonanxiety <anxiety network) : T = -58.141   <2e-16 ***; Anxiolytic status: On.anxiolytics>off.anxiolytics; T= 2.473   0.0136 *  
#Mean prop affected: on anxiolytics: 0.415625;  off anxioloytics: 0.3664898

disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer <- lmer(proportion_affected ~ Network*Anxiolytics_status + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer)
confint(disease_within_vs_outside_anxiety_net_by_anxiolytic_status_lmer)

## Anxiety network x benzo status
#Network (nonanxiety <anxiety network) : T = -54.535   <2e-16***; Anxiety status: T = 0.462    P = 0.645

disease_within_vs_outside_anxiety_net_by_benzo_lmer <- lmer(proportion_affected ~ Network*Benzo_status + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_benzo_lmer)
confint(disease_within_vs_outside_anxiety_net_by_benzo_lmer)

## Anxiety network x anxiety diagnosis
#Network (nonanxiety <anxiety network) : T = -54.535   <2e-16***; Anxiety status: T = 0.462    P = 0.645

disease_within_vs_outside_anxiety_net_by_anxietydx_lmer <- lmer(proportion_affected ~ Network*Has.anxietydx + (1|subject), data = df_empi_dx_network_proportions)
summary(disease_within_vs_outside_anxiety_net_by_anxietydx_lmer)
confint(disease_within_vs_outside_anxiety_net_by_anxietydx_lmer)
```


### Plot within vs outside network, matched groups
```{r plottting_bar_graph_matched}

#Within vs outside network
anxiety_net_group <- c(rep("Anxiety Network", times = dim(df_matched)[1]), rep("Nonanxiety Network",times =dim(df_matched)[1]))
net_values <- c(df_matched$proportion_volume_lost_anxiety_net_by_network_size_sum_top_25, df_matched$proportion_volume_lost_nonanxiety_net_by_network_size_sum_bottom_75)

newdf <- data.frame(anxiety_net_group, net_values)

newdf <- newdf %>%
  mutate( anxiety_net_group=factor(anxiety_net_group,levels=c( "Nonanxiety Network", "Anxiety Network")))

violin_within_vs_outside_network_sum_proportion_scaled_by_network_size_matched <- ggplot(newdf, aes(x=anxiety_net_group, y=net_values, fill=anxiety_net_group)) +
  geom_violin() +  
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + 
  ggtitle(paste0("Volume of Fascicle Disease Burden")) +
  ylab("Proportion of network affected") +
  ylim(0,1) + 
  scale_fill_manual(values=c("#D3D3D3", "#841DE2")) +
  theme(plot.title = element_text(size=16, hjust = 0.55),
        axis.text = element_text(size = 16, colour = "black"), axis.title.y  = element_blank(), 
        axis.title.x = element_text(size=16),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        legend.position = "none",
        aspect.ratio=4/7,
        panel.background = element_rect(colour = "white", fill = "white")) + 
  coord_flip() 

#display
violin_within_vs_outside_network_sum_proportion_scaled_by_network_size_matched
```


## Compare disease burden by anxiety comorbidity by fascicle
```{r compare_disease_burden_by_anxiety_comorbidity}

#### in each fascicle
#lm
fascicle_number_of_anxiety_dx_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ number_of_anxiety_comorbidities_extended, list(i = as.name(x))), data = df_demo_and_fascicles)
})
names(fascicle_number_of_anxiety_dx_lm) <- fascicle_names_w_prop_suffix
fascicle_number_of_anxiety_dx_anova <- lapply(fascicle_number_of_anxiety_dx_lm, anova)

##uncorrected
p_anova <- as.data.frame(sapply(fascicle_number_of_anxiety_dx_anova, function(v) v$"Pr(>F)"[1]) )

#extract values that are significant
p_anova_unc <- as.data.frame(cbind(row.names(p_anova)[p_anova < 0.05], p_anova[p_anova <0.05]))

#print BEFORE FDR correction 
print(p_anova_unc)


#fdr corrected
fascicle_number_of_anxiety_dx_anova_fdr <- fdr_anova_generic(fascicle_number_of_anxiety_dx_anova, 1)
print(fascicle_number_of_anxiety_dx_anova_fdr)

## limbic area disease by anxiety diagnosis

yeo_lim_no_anxiety <- lm(LIM~number_of_anxiety_comorbidities_extended, data = df_demo_and_fascicles) #nothing

```



## Has depression AND anxiety diagnoses
```{r compare_disease_burden_by_dep_AND_anxiety_comorbidity}

#lm
fascicle_depANDanx_dx_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ Has.depANDanx.dx, list(i = as.name(x))), data = df_demo_and_fascicles)
})
names(fascicle_depANDanx_dx_lm) <- fascicle_names_w_prop_suffix
fascicle_depANDanx_dx_anova <- lapply(fascicle_depANDanx_dx_lm, anova)

##uncorrected
p_anova <- as.data.frame(sapply(fascicle_depANDanx_dx_anova, function(v) v$"Pr(>F)"[1]) )

#extract values that are significant
p_anova_unc <- as.data.frame(cbind(row.names(p_anova)[p_anova < 0.05], p_anova[p_anova <0.05]))

#print BEFORE FDR correction 
print(p_anova_unc)

#fdr corrected
fascicle_depANDanx_dx_anova_fdr <- fdr_anova_generic(fascicle_depANDanx_dx_anova, 1)
print(fascicle_depANDanx_dx_anova_fdr)

```

#compare disease burden by psychiatric comorbidity
```{r compare_disease_burden_between_anxiety_and_no_psych_dx}

#lm
fascicle_number_of_psychiatric_dx_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ number_of_psychiatric_comorbidities_extended, list(i = as.name(x))), data = df_demo_and_fascicles)
})
names(fascicle_number_of_psychiatric_dx_lm) <- fascicle_names_w_prop_suffix

fascicle_number_of_psychiatric_dx_anova <- lapply(fascicle_number_of_psychiatric_dx_lm, anova)

#Pull p-values
p_anova <- as.data.frame(sapply(fascicle_number_of_psychiatric_dx_anova, function(v) v$"Pr(>F)"[1]) )

#extract values that are significant
p_anova_unc <- as.data.frame(cbind(row.names(p_anova)[p_anova < 0.05], p_anova[p_anova <0.05]))

#print BEFORE FDR correction 
print(p_anova_unc)



#fdr corrected
fascicle_number_of_psychiatric_dx_anova_fdr <- fdr_anova_generic(fascicle_number_of_psychiatric_dx_anova, 1)
print(fascicle_number_of_psychiatric_dx_anova_fdr)


## yeo
#lm
psych_comorbidity_lm_yeo <- lapply(yeo_network_names, function(x) 
{
  lm(substitute(i ~ number_of_psychiatric_comorbidities_extended, list(i = as.name(x))), data = df_demo_and_fascicles)
})
names(psych_comorbidity_lm_yeo) <- yeo_network_names

psych_comorbidity_yeo_anova <- lapply(psych_comorbidity_lm_yeo, anova)

#uncorrected
#Pull p-values
p_anova <- as.data.frame(sapply(psych_comorbidity_yeo_anova, function(v) v$"Pr(>F)"[1]) )

#extract values that are significant
p_anova_unc <- as.data.frame(cbind(row.names(p_anova)[p_anova < 0.05], p_anova[p_anova <0.05]))

#print BEFORE FDR correction 
print(p_anova_unc)


#fdr corrected
psych_comorbidity_yeo_anova_fdr <- fdr_anova_generic(psych_comorbidity_yeo_anova, 1)
print(psych_comorbidity_yeo_anova_fdr)


```

##compare disease in anxiety versus patients with no psychiatric comorbidity
```{r anxiety_vs_healthy_ish}

anxiety_vs_no_psych <- df_demo_and_fascicles %>%
  mutate(anxietyGroupVar = ifelse(Has.anxietydx, 2, ifelse(healthy_ish, 1, 0))) %>% #complicated, if they have an anxiety disorder, they get a 2, if they are health-ish, no psych dx or meds, 1, otherwise, exclude
  filter(anxietyGroupVar != 0) %>% #get rid of the people who are not anxious and not healthy_ish, n =643, lost n=169
  filter(is.na(depGroupVar)) %>% #exclude people with depression (87 have both depression and anxiety), n = 557, anxiety = 101, nonanxious = 456)
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  slice(1) %>%
  ungroup


#lm
anxiety_vs_no_psych_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ anxietyGroupVar, list(i = as.name(x))), data = anxiety_vs_no_psych)
})
names(anxiety_vs_no_psych_lm) <- fascicle_names_w_prop_suffix

anxiety_vs_no_psych_lm_anova <- lapply(anxiety_vs_no_psych_lm, anova)

#uncorrected
#Pull p-values
p_anova <- as.data.frame(sapply(anxiety_vs_no_psych_lm_anova, function(v) v$"Pr(>F)"[1]) )

#extract values that are significant
p_anova_unc <- as.data.frame(cbind(row.names(p_anova)[p_anova < 0.05], p_anova[p_anova <0.05]))

#print BEFORE FDR correction 
print(p_anova_unc)


#fdr corrected
anxiety_vs_no_psych_lm_anova_fdr <- fdr_anova_generic(anxiety_vs_no_psych_lm_anova, 1)
print(anxiety_vs_no_psych_lm_anova_fdr)


## yeo
#lm
anxiety_vs_no_psych_lm_yeo <- lapply(yeo_network_names, function(x) 
{
  lm(substitute(i ~ anxietyGroupVar, list(i = as.name(x))), data = anxiety_vs_no_psych)
})
names(anxiety_vs_no_psych_lm_yeo) <- yeo_network_names

anxiety_vs_no_psych_yeo_anova <- lapply(anxiety_vs_no_psych_lm_yeo, anova)

#uncorrected
#Pull p-values
p_anova <- as.data.frame(sapply(anxiety_vs_no_psych_yeo_anova, function(v) v$"Pr(>F)"[1]) )


#extract values that are significant
p_anova_unc <- as.data.frame(cbind(row.names(p_anova)[p_anova < 0.05], p_anova[p_anova <0.05]))

#print BEFORE FDR correction 
print(p_anova_unc)




#fdr corrected
anxiety_vs_no_psych_yeo_anova_fdr <- fdr_anova_generic(anxiety_vs_no_psych_yeo_anova, 1)
print(anxiety_vs_no_psych_yeo_anova_fdr)

### total lesion burden

### lesion volume

```
### Run analysis again but include in anxiety group people on anti-anxiety meds
```{r anxiety_oranxiety_meds_vs_healthy_ish}

anxiety_vs_no_psych <- df_demo_and_fascicles %>%
  mutate(anxietyGroupVar = ifelse((Has.anxietydx | On.Anxiolytics_no_beta_blocker), 2, ifelse(healthy_ish, 1, 0))) %>% #complicated, if they have an anxiety disorder, they get a 2, if they are health-ish, no psych dx or meds, 1, otherwise, exclude; n anxiety = 271, healthyish = 448, unclassified = 93
  mutate(anxietyGroupVar_ordered = ordered(anxietyGroupVar,levels = c(0,1,2), labels = c("unclassified", "healthyish", "anxiety"))) %>%
  filter(anxietyGroupVar_ordered != "unclassified") %>% #get rid of the people who are not anxious and not healthy_ish, n =541, lost n=93
  filter(is.na(depGroupVar)) %>% #exclude people with depression (87 have both depression and anxiety), n = 557, anxiety = 101, nonanxious = 456)
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  slice(1) %>%
  ungroup


#lm
anxiety_vs_no_psych_lm <- lapply(fascicle_names_w_prop_suffix, function(x) 
{
  lm(substitute(i ~ anxietyGroupVar, list(i = as.name(x))), data = anxiety_vs_no_psych)
})
names(anxiety_vs_no_psych_lm) <- fascicle_names_w_prop_suffix

anxiety_vs_no_psych_lm_anova <- lapply(anxiety_vs_no_psych_lm, anova)

#uncorrected
#Pull p-values
p_anova <- as.data.frame(sapply(anxiety_vs_no_psych_lm_anova, function(v) v$"Pr(>F)"[1]) )

#extract values that are significant
p_anova_unc <- as.data.frame(cbind(row.names(p_anova)[p_anova < 0.05], p_anova[p_anova <0.05]))

#print BEFORE FDR correction 
print(p_anova_unc)


#fdr corrected
anxiety_vs_no_psych_lm_anova_fdr <- fdr_anova_generic(anxiety_vs_no_psych_lm_anova, 1)
print(anxiety_vs_no_psych_lm_anova_fdr)


## yeo
#lm
anxiety_vs_no_psych_lm_yeo <- lapply(yeo_network_names, function(x) 
{
  lm(substitute(i ~ anxietyGroupVar, list(i = as.name(x))), data = anxiety_vs_no_psych)
})
names(anxiety_vs_no_psych_lm_yeo) <- yeo_network_names

anxiety_vs_no_psych_yeo_anova <- lapply(anxiety_vs_no_psych_lm_yeo, anova)

#uncorrected
#Pull p-values
p_anova <- as.data.frame(sapply(anxiety_vs_no_psych_yeo_anova, function(v) v$"Pr(>F)"[1]) )


#extract values that are significant
p_anova_unc <- as.data.frame(cbind(row.names(p_anova)[p_anova < 0.05], p_anova[p_anova <0.05]))

#print BEFORE FDR correction 
print(p_anova_unc)




#fdr corrected
anxiety_vs_no_psych_yeo_anova_fdr <- fdr_anova_generic(anxiety_vs_no_psych_yeo_anova, 1)
print(anxiety_vs_no_psych_yeo_anova_fdr)



```

## Compare total disease burden and lesion volume by anxiety comorbidity
```{r total_burden_and_lesion_volume_by_anxiety_comorbdity}

total_burden_by_anxietydx_lm <- lm(anxietyGroupVar~total_fascicle_volume_lost_no_cranial_nerves, data = anxiety_vs_no_psych)
print(summary(total_burden_by_anxietydx_lm))

total_burden_by_anxiety_lm <- lm(number_of_anxiety_comorbidities_extended~total_fascicle_volume_lost_no_cranial_nerves, data = anxiety_vs_no_psych)
print(summary(total_burden_by_anxiety_lm))

total_lesion_volume_by_anxietydx_lm <- lm(anxietyGroupVar ~volume_of_mimosa_lesions, data = anxiety_vs_no_psych)
print(summary(total_lesion_volume_by_anxietydx_lm))

total_lesion_volume_by_anxiety_lm <- lm(number_of_anxiety_comorbidities_extended ~volume_of_mimosa_lesions, data = anxiety_vs_no_psych)
print(summary(total_lesion_volume_by_anxiety_lm))

```

### Send anxiety groups to HYDRA (diagnosis only, no on meds)
```{r anxiety_group_prep_for_hydra}
### remake data frame from above


anxiety_vs_no_psych <- df_demo_and_fascicles %>%
  mutate(anxietyGroupVar = ifelse(Has.anxietydx, 2, ifelse(healthy_ish, 1, 0))) %>% #complicated, if they have an anxiety disorder, they get a 2, if they are health-ish, no psych dx or meds, 1, otherwise, exclude
  filter(anxietyGroupVar != 0) %>% #get rid of the people who are not anxious and not healthy_ish, n =643, lost n=169
  filter(is.na(depGroupVar)) %>% #exclude people with depression (87 have both depression and anxiety), n = 557, anxiety = 101, nonanxious = 456)
  mutate(anxietyHydraVar = ifelse(anxietyGroupVar == 2, 1, -1)) %>%
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  slice(1) %>%
  ungroup

#pull out EMPI, proportion, and anxiety group var
anxiety_vs_no_psych_features_for_hydra <- anxiety_vs_no_psych %>%
  dplyr::select(EMPI, fascicle_names_w_prop_suffix, anxietyHydraVar)

write.csv(file=paste0(homedir, "/hydra/data/Features_ms_fascicle_dysconnectome_anxiety_prop.csv"),x=anxiety_vs_no_psych_features_for_hydra, quote = F, row.names = F)

#pull out age, age + sex covariates
anxiety_age <- anxiety_vs_no_psych %>%
  dplyr::select(EMPI, PAT_AGE_AT_EXAM)

write.csv(file=paste0(homedir, "/hydra/data/Covariates_age.csv"),x=anxiety_age, quote = F, row.names = F)

anxiety_age_and_sex <- anxiety_vs_no_psych %>%
  dplyr::select(EMPI, PAT_AGE_AT_EXAM, sex_binarized)

write.csv(file=paste0(homedir, "/hydra/data/Covariates_age_and_sex.csv"),x=anxiety_age_and_sex, quote = F, row.names = F)

#pull out yeo proportions
anxiety_vs_no_psych_yeo_features_for_hydra <- anxiety_vs_no_psych %>%
  dplyr::select(EMPI, yeo_network_names_prop, anxietyHydraVar)

write.csv(file=paste0(homedir, "/hydra/data/Features_ms_fascicle_dysconnectome_anxiety_yeo_prop.csv"),x=anxiety_vs_no_psych_yeo_features_for_hydra, quote = F, row.names = F)


```


### Send anxiety groups to HYDRA ((diagnosis only + benzos)
```{r anxiety_group_prep_for_hydra}
### remake data frame from above


anxiety_vs_no_psych <- df_demo_and_fascicles %>%
  filter(anxietydxANDbenzoGroupVar != 0) %>% #get rid of the people who are not anxious and not healthy_ish, n =662, lost n=150
  filter(depGroupVar!=2) %>% #exclude people with depression , n =568, lost 104
  mutate(anxietyHydraVar = ifelse(anxietyGroupVar == 2, 1, -1)) %>%
  group_by(EMPI) %>%
  arrange(EXAM_DATE) %>%
  slice(1) %>%
  ungroup

#pull out EMPI, proportion, and anxiety group var
anxiety_vs_no_psych_features_for_hydra <- anxiety_vs_no_psych %>%
  dplyr::select(EMPI, fascicle_names_w_prop_suffix, anxietyHydraVar)

write.csv(file=paste0(homedir, "/hydra/data/Features_anxietydxANDbenzo_prop.csv"),x=anxiety_vs_no_psych_features_for_hydra, quote = F, row.names = F)

#pull out age, age + sex covariates
anxiety_age <- anxiety_vs_no_psych %>%
  dplyr::select(EMPI, PAT_AGE_AT_EXAM)

write.csv(file=paste0(homedir, "/hydra/data/Covariates_anxietydxANDbenzo_age.csv"),x=anxiety_age, quote = F, row.names = F)

anxiety_age_and_sex <- anxiety_vs_no_psych %>%
  dplyr::select(EMPI, PAT_AGE_AT_EXAM, sex_binarized)

write.csv(file=paste0(homedir, "/hydra/data/Covariates_anxietydxANDbenzo_age_and_sex.csv"),x=anxiety_age_and_sex, quote = F, row.names = F)

#pull out yeo proportions
anxiety_vs_no_psych_yeo_features_for_hydra <- anxiety_vs_no_psych %>%
  dplyr::select(EMPI, yeo_network_names_prop, anxietyHydraVar)

write.csv(file=paste0(homedir, "/hydra/data/Features_anxietydxANDbenzo_yeo_prop.csv"),x=anxiety_vs_no_psych_yeo_features_for_hydra, quote = F, row.names = F)


```


## Depression versus healthy analysis

    
```{r demographics}

#this will display a demographics table comparing age, race, sex between healthy and depressed groups, using the first presentation to treatment

make_demographics_table_ms(data_frame = data_2023_pull)

df_unique_empi <- data_empi_acc_f_phq %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 

make_demographics_table_ms(data_frame = df_unique_empi)

df_just_healthy_and_depressed <- df_unique_empi %>% filter(depGroupVar != 0)

make_demographics_table_ms(data_frame = df_just_healthy_and_depressed)


#just people with good mimosa
df_good_mimosa <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
make_demographics_table_ms(data_frame = df_good_mimosa)

df_good_mimosa_unique <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 
make_demographics_table_ms(data_frame = df_good_mimosa_unique)
```


```{r proof_of_concept}

#this section creates histograms looking at the proportion of volume lost in each fascicle across subjects
#we recapitulate earlier work and show that higher volume loss with our method reflects regions previously known to have higher volume loss
#These findings suggest that the streamline filtering approach could be a reasonable approach for this analysis

#have to pull out just the pieces I'm interested in
just_dep_and_empi <- subset(data_empi_acc_f_phq, select = c("EMPI", "depGroupVar"))
added_dep_to_fascicles <- merge(just_dep_and_empi, fascicle_proportions, by = c("EMPI"))
melted_df <- melt(added_dep_to_fascicles, id.vars = c("EMPI", "EXAM_DATE", "depGroupVar"))

#exclude regions where there was no lesion at all
lesioned <- subset(melted_df, value > 0)

#only include people in healthy or depressed group
lesioned_dx <- subset(lesioned, depGroupVar != 0)

#separate out healthy and depressed
healthy <- subset(lesioned, depGroupVar == 1)
depressed <- subset(lesioned, depGroupVar == 2)

q<-ggplot(lesioned, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r<-ggplot(lesioned_dx, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r_color<-ggplot(lesioned_dx, aes(x=value, color=factor(depGroupVar))) + geom_histogram() + facet_wrap(~variable)
x<-ggplot(lesioned, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
y<-ggplot(healthy, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
z<-ggplot(depressed, aes(x=value)) + geom_histogram() + facet_wrap(~variable)

#print(q)
#print(r)
print(r_color)
#print(x)
#print(y)
#print(z)
```

```{r age_effects_fascicles_unique}
########### age effect whole group

#isolate out only the depressed group and healthy group
df_demo_and_fascicles_no_unclass_anxiety_dose <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


#### age histo ###
hist(df_demo_and_fascicles_no_unclass_anxiety_dose$PAT_AGE_AT_EXAM,
main = paste0("Age In Good Mimosa Group : n = ", dim(df_demo_and_fascicles_no_unclass_anxiety_dose)[1]), xlab = "Age", breaks = 10)

#lm
fascicle_age_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_age_lm) <- fascicle_names

#anova
fascicle_age_anova <- lapply(fascicle_age_lm, anova)

#fdr corrected
fascicle_age_anova_fdr <- fdr_anova_generic(fascicle_age_anova, 1)
print(fascicle_age_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_age_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_age_lm,visreg)
visreg(fascicle_age_lm$AF_R,ylab = "Proportion of Affected Streamlines", xlab = "Age in Years",
       line=list(col="red"),
       points=list(col="black"))

```


```{r sex_effects_fascicles_unique}

### really not interesting at all. 3 areas that are uncorrected: SCP, CPT_O_R, OR_R

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sex_anova_p <- sapply(fascicle_sex_anova, function(v) v$"Pr(>F)"[1])
fascicle_sex_anova_p05_unc <- as.data.frame(fascicle_sex_anova_p[fascicle_sex_anova_p < 0.05])
print(fascicle_sex_anova_p05_unc)

```



```{r depression_unique_all_fascicles_together_in_dep_networks}

#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
   mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


dep_vs_healthy <- lm(total_fascicle_prop_lost ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy) #p=0.494, cohen d = 0.2


#power analysis to predict sample required for K, u = num df, v = denom df, f2=0.01 (cohen d = 0.02/2) 
#prop in each fascicle predicting dep (87), number of predictors (age, sex, ef, ess?) = 4, u = 87-4 = 83
pwr.f2.test(u=83, f2 = 0.02, sig.level = 0.5, power = 0.8)

#test whether proportion lost overall different between depressed and healthy- yes, p = 0.049
total_volume_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 27%, mean non_dep = 24%, p = 0.049


df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)

plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed"))

print(plot)

#bar plot
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)



#look at within depression network specifically - trend, p = 0.059
total_volume_lost_dep_vs_healthy_unique_in_dep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 36%, mean non_dep = 32%, p = 0.071

#look at within depression network in fascicles where at least 10% of the volume of the fascicle was in dep network
#yes, p = 0.048
total_volume_lost_dep_vs_healthy_unique_in_dep_network_10percent <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 33%, mean non_dep = 27%, p = 0.048

#look at within depression network in fascicles where at least 5% of the volume of the fascicle was in dep network
#yes, 
total_volume_lost_dep_vs_healthy_unique_in_dep_network_5percent <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 32%, mean non_dep = 27%, p = 0.056


#look at outside depression network, yes p = 0.037
total_volume_lost_dep_vs_healthy_unique_in_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 18%, mean non_dep = 16%, p = 0.037

### Age actually makes things worse
#dep_vs_healthy_w_age <- lm(total_fascicle_prop_lost ~ depGroupVar + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)
#summary(dep_vs_healthy_w_age)

#df for visreg - actually not using visreg. Just a nice way to see that there is significantly more loss in depression network versus outside depression network





```

```{r depressed_versus_healthy_unique_subjs_indiv_fascicle}
##### repeat above analysis but use only the first instance of each EMPI, sorted by date
df_unique_empi <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 


#lm
fascicle_lm_unique <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = df_unique_empi)
})
names(fascicle_lm_unique) <- fascicle_names

#anova
fascicle_anova_unique <- lapply(fascicle_lm_unique, anova)

#fdr corrected
fascicle_anova_unique_fdr <- fdr_anova_generic(fascicle_anova_unique, 1)
print(fascicle_anova_unique_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector ==2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 5% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_volumes_dep_network$prop_in_mask >= 0.05)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)


#uncorrected
fascicle_anova_unique_p <- sapply(fascicle_anova_unique, function(v) v$"Pr(>F)"[1])
fascicle_anova_unique_p05_unc <- as.data.frame(fascicle_anova_unique_p[fascicle_anova_unique_p < 0.05])
print(fascicle_anova_unique_p05_unc)

### plot AF_R 

df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)



plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  ggtitle("Arcuate Fasciculus R") + 
 # geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed")) 
  
print(plot)

### Plot OR_R	0.69024050
df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$OR_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$OR_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)



plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  ggtitle("Optic Radiation R") + 
 # geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed")) 
print(plot)


### grouped bar plot

Diagnosis <- c(rep("Depressed" , 2) , rep("Non-Depressed" , 2))
Fascicle <- rep(c("Depression Network (AF)" , "Region Outside Depression Network (C_PH)"), 2)
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]),
           mean(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1 ))),
          (sd(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1 ))))

data <- data.frame(Diagnosis,Fascicle,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)


# Grouped
barplot <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)


barplot2 <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity", colour = "black", width=0.9,size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1) + 
    scale_fill_manual(values = c("#cdcdcd", "#FFFFFF", "#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
 
    ylab("Proportion of Fascicles Affected") +
    theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
          axis.title.y = element_text(size=20),
          axis.line = element_line(size = 1.5, colour = "black", linetype=1),
          panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty graph
    scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph


print(barplot2)


```

```{r testing_whether_ms_disease_more_likely_in_depression_mask_unique}
### tests whether there is higher proportion of vertices lost in depression network versus not

dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ### when I filter and remove fascicles where there was no loss at all, the depression vs healthy findings go away
#  filter(total_fascicle_prop_lost > 0) %>%
  ungroup()


#test whether there is differentially more volume loss in depression versus nondepression network
volume_lost_dep_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep_net = 35%, mean non_dep_net =  17%, p 2.2 x 10^-16

volume_lost_dep10_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep net = 31%, mean non_dep_net = 17%, p 2.2 * 10^-16

volume_lost_dep5_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep net = 30%, mean non_dep_net = 17%, p 2.2 * 10^-16

#df for visreg - actually not using visreg. Just a nice way to see that there is significantly more loss in depression network versus outside depression network
df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "network")
df_for_visreg$network <- as.factor(df_for_visreg$network)

plot <- ggplot(df_for_visreg, aes(x=network, y = prop_lost, col=network)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="red") + 
  scale_x_discrete(labels=c("1" = "Depression Network", "2" = "Non-Depression Network")) + 
  ylab("Proportion of Fascicles Affected") + 
  theme(axis.text =element_text(size=14), axis.title.x = element_blank())
  
print(plot)

########## Bar plot
Network <- c("Depression Network","Non-Depression Network")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet)/sqrt(dim(dep_and_healthy_groups_for_ICD_analysis)[1])),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network)/sqrt(dim(dep_and_healthy_groups_for_ICD_analysis)[1])))

data <- data.frame(Network,value,sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Network,fill=Network, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)
# Black and white
barplot <- ggplot(data, aes(x=Network,fill=Network, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph


print(barplot)



###### Depression network x depression group interaction - It is there, depression always worse. 
#these lms largely match up with the t.tests above. Sig differences between depressed (more disease) within and outside of mask

loss_in_dep_network <- lm(total_fascicle_prop_lost_indepnet~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #non sig, p = 0.061
loss_in_dep_network_10_percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #p = 0.0492
loss_in_nondep_network <- lm(total_fascicle_prop_lost_nondep_network~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #p=0.037
```


```{r phq9_correlation_fascicles}

####### NOTHING SIGNIFICANT!!!! ########3
#isolate out only the depressed group and healthy group
with_phq9 <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0) %>%
  filter(!is.na(PHQ.9)) %>%
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.9, list(i = as.name(x))), data = with_phq9)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- fascicle_anova_p[!is.na(fascicle_anova_p) & fascicle_anova_p < 0.05]
print(fascicle_anova_p05_unc)


######### overall fascicle proportion affected - nothing is significant
overall_prop_affected <- lm(total_fascicle_prop_lost~PHQ.9, data=with_phq9)
overall_prop_affected_depnet <- lm(total_fascicle_prop_lost_indepnet~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_10percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_5percent <- lm(total_fascicle_prop_lost_indepnet_5_percent~PHQ.9, data=with_phq9)
overall_prop_affected_nondep <- lm(total_fascicle_prop_lost_nondep_network~PHQ.9, data=with_phq9)
```

```{r phq9_regressions_just_dep_group}
##### NOTHING SIGNIFICANT ########
##################################
## Just within depression group ##
##################################
#isolate out only the depressed group and healthy group
with_phq9 <- df_demo_and_fascicles %>%
  filter(depGroupVar == 2) %>%
  filter(!is.na(PHQ.9)) %>%
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()
#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.9, list(i = as.name(x))), data = with_phq9)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)


#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- fascicle_anova_p[!is.na(fascicle_anova_p) & fascicle_anova_p < 0.05]
print(fascicle_anova_p05_unc)

######### overall fascicle proportion affected - nothing is significant
overall_prop_affected <- lm(total_fascicle_prop_lost~PHQ.9, data=with_phq9)
overall_prop_affected_depnet <- lm(total_fascicle_prop_lost_indepnet~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_10percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_5percent <- lm(total_fascicle_prop_lost_indepnet_5_percent~PHQ.9, data=with_phq9)
overall_prop_affected_nondep <- lm(total_fascicle_prop_lost_nondep_network~PHQ.9, data=with_phq9)

#visreg
#sapply(fascicle_lm, visreg)
```
All the mixed models are below
```{r age_effects_indiv_fascicles_mm}

### This subscript compares proportion of fascicles lost across age for each fascicle of the 80+. Looks lonly at the people in the depressed versus healthy group. Importantly, I ran this looking at everyone, at the results are the same.
### Separately considers findings just within the association cortex

#isolate out only the depressed group and healthy group
df_mm <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
#n depressed = 859, healthy = 604, total n = 1463


#lm
fascicle_lm_mm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ PAT_AGE_AT_EXAM + (1 | EMPI), list(i = as.name(x))), data = df_mm)
})
names(fascicle_lm_mm) <- fascicle_names

#anova
fascicle_anova_mm <- lapply(fascicle_lm_mm, anova)

#fdr corrected
fascicle_anova_mm_fdr <- fdr_anova_generic(fascicle_anova_mm, 1)
print(fascicle_anova_mm_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_mm_p <- sapply(fascicle_anova_mm, function(v) v$"Pr(>F)"[1])
fascicle_anova_mm_p05_unc <- as.data.frame(fascicle_anova_mm_p[fascicle_anova_mm_p < 0.05])
print(fascicle_anova_mm_p05_unc)


```

```{r sex_effects_fascicles_mm}
########### sex effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0) 
#healthhy = 713, total n = 1106

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ osex + (1|EMPI), list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_sex_lm,visreg)
```

```{r depressed_versus_healthy_indiv_fascicles_mm}

### This subscript compares proportion of fascicles lost for each fascicle of the 80+ between those in the depressed and the clean healthy group. Done as both a mixed model as well as using unique individuals alone.

#Of note, adding age into this model makes things WORSE

### Separately considers findings just within the association cortex
#isolate out only the depressed group and healthy group
df_mm <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
#n depressed = 859, healthy = 604, total n = 1463


#lm
fascicle_lm_mm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ depGroupVar + (1 | EMPI), list(i = as.name(x))), data = df_mm)
})
names(fascicle_lm_mm) <- fascicle_names

#anova
fascicle_anova_mm <- lapply(fascicle_lm_mm, anova)

#fdr corrected
fascicle_anova_mm_fdr <- fdr_anova_generic(fascicle_anova_mm, 1)
print(fascicle_anova_mm_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_mm_p <- sapply(fascicle_anova_mm, function(v) v$"Pr(>F)"[1])
fascicle_anova_mm_p05_unc <- as.data.frame(fascicle_anova_mm_p[fascicle_anova_mm_p < 0.05])
print(fascicle_anova_mm_p05_unc)


```


Lastly, this section will explore interactions (age * dep), (sex * dep)

```{r age_by_depression_unique}

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_agedep_lm <- lapply(fascicle_names, function(x) 
{
   lm(substitute(i ~ PAT_AGE_AT_EXAM*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
# lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM + osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_agedep_lm) <- fascicle_names

#anova
fascicle_agedep_anova <- lapply(fascicle_agedep_lm, anova)


#fdr corrected - depression alone
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 2)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected - interaction
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 3)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_agedep_anova, function(v) v$"Pr(>F)"[3])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)
```

```{r sex_by_depression_unique}

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_sexdep_lm <- lapply(fascicle_names, function(x) 
{
   lm(substitute(i ~ osex*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)

})
names(fascicle_sexdep_lm) <- fascicle_names

#anova
fascicle_sexdep_anova <- lapply(fascicle_sexdep_lm, anova)


#fdr corrected - depression alone
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 2)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[2])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)

#fdr corrected - interaction
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 3)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[3])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)
```
Interaction models below

```{r sexdep_effects_fascicles_unique}

### Trying to figure out if there are any sex * depression effects, covarying for age given that men tend to get worse over time. dep*sex uncorrected in SLF1_L and CNVIII_R p< 0.05)

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sexdep_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ depGroupVar*osex + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sexdep_lm) <- fascicle_names

#anova
fascicle_sexdep_anova <- lapply(fascicle_sexdep_lm, anova)


##### depGroupVar ####
### 12 areas, nearly identical to reg model

#fdr corrected
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 1)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[1])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) ### CNVIII p < 0.05

##### sex differences ####
## same as above, just add in CNVIII_R

#fdr corrected
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 2)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[2])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) ### CNVIII p < 0.05


#######interaction ####

### SLF1_L and CNVIII_R

#fdr corrected interaction
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 4)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,4)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,4)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[4])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) #p uncorrected slf1_L p = 0.0488, CNVIII_R 0.01)


### grouped bar and line plot

Diagnosis <- c(rep("Depressed" , 2) , rep("Non-Depressed" , 2))
Sex <- rep(c("Male" , "Female"), 2)
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)]))


sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)))))
           

data <- data.frame(Diagnosis,Sex,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(fill=Sex, y=value, x=Diagnosis)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of SLF Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)

lineplot <- ggplot(data=data, aes(fill=Sex, y=value, x=Diagnosis, group = Sex)) + 

    geom_line(aes(color=Sex, size=0.9)) +
    geom_point(aes(color=Sex, size=0.9)) +
    ylim(0.05,0.30)+
    ylab("Proportion of SLF Affected") +
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1) + 
    theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank())
    
print(lineplot)



```

